C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE PRINCIPAL_MF
OBJECT MODULE PLACED IN .\hex\Principal_MF.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Principal_MF.C LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\libreria) DEBUG O
                    -BJECTEXTEND TABS(2) OBJECT(.\hex\Principal_MF.obj)

line level    source

   1          #include <at89c51xd2.h>
   2                      
   3          #include <stdio.h>          //                            *
   4          #include <INTRINS.H>        //                            *
   5          #include <math.h>                   //                            *          
   6          #include <string.h>
   7          #include "display.h"        //                            *
   8          #include "wiegand.h"
   9          #include "uart.h"
  10          //*******************************************************************************************
  11          //  DEFINICION DE IO DEL MICROCONTROLADOR                         *
  12          //*******************************************************************************************
  13          //sbit sw_1 = P1^2;         //Direccion                       *
  14          //sbit sw_2 = P1^3;         //Direccion                       *
  15          sbit ledv = P1^4;         //Led del boton expedidor               *
  16          sbit lock1  = P1^6;         //Relevo de Entrada                   *
  17          sbit lock2  = P1^5;         //Relevo de Salida (Inhabilitado Proc. Aux usa ERR IMP) *
  18          
  19          sbit msg1  = P0^0;          //Relevo de Salida (AUDIO)                *
  20          sbit msg2  = P0^1;          //Relevo de Salida (AUDIO)                *
  21          sbit msg3  = P0^2;          //Relevo de Salida (AUDIO)                *
  22          sbit msg4  = P0^3;          //Relevo de Salida (AUDIO)                *
  23          
  24          sbit automovil  = P1^7;       //Entrada sensor automovil / Cajon Monedero       *
  25          sbit SignalAcceso = P3^7;     //Sigue la señal de Sensor      sensor 1          *
  26          sbit busy=P3^5;             //                            *
  27          sbit ready=P3^4;          //                            *
  28          sbit bus_clk=P3^6;          //  
  29          //sbit RS = P1^0 ;                  /* define I/O functions     */
  30          //sbit E =  P1^1 ;                  /* P3.5             */
  31          
  32          
  33          //                        */
  34          //*******************************************************************************************
  35           unsigned char sin_sensor   []= "ERROR:  LOOP 1  " ;
  36           unsigned char linea        []= " FUERA DE LINEA " ;
  37           unsigned char err_mifare   []= " ERROR MIFARE   " ;
  38           unsigned char err_cod      []= "ERROR COD. PARQ." ;
  39           unsigned char err_in       []= "  SIN INGRESO   " ;
  40           unsigned char err_sinpago  []= "NO REGISTRA PAGO" ;
  41           unsigned char err_gracia   []= "EXCEDE T.GRACIA " ;
  42          
  43           unsigned char MSGnegado    []= " ACCESO NEGADO  " ;
  44           unsigned char err_out      []= "   SIN SALIDA   " ;
  45           unsigned char err_data     []= "ERROR GRABACION " ;
  46           unsigned char err_Caja     []= "ACERQUESE A CAJA" ;
  47           unsigned char serie        []= "SERIE:          " ;
  48           unsigned char matchPlate   []= "COMPARANDO PLACA" ;
  49           unsigned char tarjeta_venc []= "TARJETA VENCIDA " ;
  50          //******************************************************************************************* 
  51          
  52          #define    cte_seg  0x1c
  53          #define    cte_retry  0x2a
  54          
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 2   

  55          
  56           unsigned char seg,k;
  57          
  58           unsigned char g_cContByteRx=0;
  59           unsigned char g_cDirBoard=0x31;
  60          
  61           unsigned char num_chr;
  62           unsigned char g_cRelevos;
  63           unsigned int TimeOut_Codigo;
  64           unsigned int TimeOut_Wiegand;
  65           unsigned char TimeOutLinea;
  66           unsigned char len_buffer;
  67           unsigned char num_data;
  68          
  69           unsigned int iTimeEsperaRtaLPR=0;
  70          
  71           unsigned char Ini_Fecha;
  72           unsigned char Ini_Dcto;
  73          
  74           unsigned char YearIn;
  75           unsigned char MonthIn;
  76           unsigned char DayIn;
  77           unsigned char HourIn;
  78           unsigned char MinutIn;
  79          
  80           unsigned char YearOut;
  81           unsigned char MonthOut;
  82           unsigned char DayOut;
  83           unsigned char HourOut;
  84           unsigned char MinutOut;
  85          
  86           unsigned char Tipo_Vehiculo;
  87           unsigned char xTipo_Vehiculo;
  88           unsigned int TimeOut_Send_Acceso=0;
  89          
  90           unsigned char NumDatRetry=0;
  91          
  92          //ESTADOR RECEPCION SOFTWARE
  93          
  94          #define ESPERA_RX       0
  95          #define VER_DIR         1
  96          #define VER_COMANDO       2
  97          #define POLL_COM_SOF      3
  98          #define WRITE_COM_SOF     4
  99          #define RECEPCION_STR_SOF_STX 5
 100          #define SAVE_STR_SOF      6
 101          #define ANALICE_STR_SOF     7
 102          #define RECEPCION_ID      8
 103          
 104          
 105          #define TAMANO_RX_COM_SOFT  60  
 106          #define TAMANO_TX_COM_SOFT  50
 107          
 108          //ESTADOR TRANSMICION SOFTWARE
 109          
 110          #define SIN_LECTURA_TX  0x00
 111          #define LECTURA_COD_TX  0x01
 112          #define LECTURA_WIEG_TX 0x02
 113          #define COD_PRINT_TX  0x04
 114          #define LPR_TX      0x08   //reconocimiento placa
 115          
 116          unsigned char g_cEstadoComSoft=ESPERA_RX;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 3   

 117          unsigned char g_cEstadoTxSoft=SIN_LECTURA_TX;
 118          
 119          
 120          
 121          
 122          unsigned char g_scArrRxComSoft[TAMANO_RX_COM_SOFT];
 123          unsigned char g_scArrTxComSoft[TAMANO_TX_COM_SOFT];
 124          
 125          unsigned char g_scArrDisplay[32];
 126          
 127          unsigned char xdata buffer_bus[30];
 128          
 129           unsigned char xdata BufferRetry[20];
 130          
 131          
 132           unsigned char xdata buffer_ticket[20];
 133          
 134           unsigned char xdata buffer_placa[10];
 135          
 136           extern unsigned char xdata buffer_wie[];
 137           unsigned char xdata buffer_wieLPR[4];
 138           unsigned char xdata buffer_Cupo[5];    //buffer donde almaceno el numero de cupos jp
 139          
 140          
 141          
 142           unsigned char  NumDatosPlate=0;
 143           unsigned char  Max_Len_Placa=0;
 144           unsigned char  NumChrTicket=0;
 145           unsigned char  Num_Char_LPR=0;
 146          
 147           unsigned char temp;
 148           unsigned char Rechazo;
 149           unsigned char Seg_OFF=5;
 150           unsigned char TimeRetryCmd=0;
 151           char nbitsW;
 152           unsigned char Cod_Dcto;
 153           
 154           
 155           unsigned int OpenMensual_Apx=0;
 156          
 157          #define ENQ 5
 158          #define EOT 4
 159          #define ACK 6
 160          #define STX 2
 161          #define ETX 3
 162          #define CR  0x0d
 163          #define LF  0x0a
 164          
 165          #define GRACIAS     0X01
 166          #define BIENVENIDO    0X02
 167          #define NO_REGIST   0X04
 168          #define LOT_FULL    0X05
 169          #define ERROR_LOOP  0x06
 170          #define EXCEDE_HORARIO  0X07
 171          #define MENSUAL_NO_PAGO 0X08
 172          #define UN_MOMENTO      0X09
 173          #define NO_PAGO         0xe7      
 174          
 175          #define SOLICITA_EVN  0XAA
 176          
 177          #define NO_MENSUAL  0XB1
 178          #define NO_IN_PARK  0XB2
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 4   

 179          #define IN_PARK   0Xb3
 180          #define EXPIRO    0Xb4
 181          #define HORARIO   0Xb5
 182          #define OFF_LINE  0XB6
 183          #define ON_LINE   0XB7
 184          #define IN_HORARIO  0Xb8
 185          #define DiaX    0XB9
 186          
 187          #define ACCESO    0Xab
 188          
 189          
 190          #define PICO_PLACA    0XF3
 191          #define RECHAZADA   0XF9
 192          #define SIN_TARJETAS    0XFA
 193          
 194          
 195          #define TIMEW   0x1e          //Tiempo para indicar TimeOut
 196          #define T_MS    20          // Base para 1ms en Espera a tx Bus
 197          #define MAX_CHR   30          // Maximo Numero CHR a recibir del secundario
 198          
 199          
 200          #define LOOP  0
 201          #define CARD  1
 202          
 203          
 204           bit sendactive=0;                // flag: marks transmitter active
 205           bit rx_dat=0;
 206           bit toggle=0;
 207          
 208           bit rx_serie=0;
 209           bit bandera_rx_soft=0;
 210           bit txACK=0;
 211          
 212           bit inicio_wiegand;
 213           bit lectura_wiegand;
 214          // bit flanco_wiegand;
 215          
 216           bit audio1=0;
 217           bit audio2=0;                
 218           bit audio3=0;
 219           bit audio4=0;
 220          
 221           bit msg_error=0;      
 222           bit notifyEVP;
 223           bit retry;
 224           bit FueraLinea=0;
 225           bit ACCESO_USE_LPR;
 226           bit Flag_Dcto=0;
 227           bit datos_validos=0;
 228           bit Dif_Mot_Car=0;
 229           bit send_markCashierAut;
 230           bit Send_Wiegand=0;
 231           bit InhabilitaPulsoEvPOut=0;
 232           bit Send_Tipo_Veh=CARD;    //modificado 23/01/2019 jp          LOOP;
 233           bit SerieOK=0;
 234           bit Dato_OffLine=0;
 235           bit Off_Line_Salida=0;
 236           bit Atascado=0;
 237           bit Habilita_Lectura=1;
 238          
 239           bit Dato_Placa=0;
 240           bit Tiquete_Placa=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 5   

 241           bit Tiquete_Salida=0;
 242          
 243           bit Tx_Acceso=0;
 244           bit SalidaW=0;
 245           bit Central_ID_OFFLINE=0;
 246           bit OrigenTipoVeh=CARD;
 247           bit ErrorTx=0;
 248           bit RetryCmd=0;
 249          
 250          
 251          extern unsigned char completo;
 252          extern  unsigned char codebits[];
 253          extern  unsigned char nex_bit;
 254          extern  unsigned char facility_code;
 255          extern  unsigned char card_number;
 256          extern  unsigned char card_number1;
 257          extern  unsigned char card_number2;
 258          extern  void Retransmitir_trama_hora();
 259          
 260          //*******************************************************************************************
 261          void Pulso_Bus(void)
 262          {
 263   1        bus_clk=0;
 264   1        wait_ancho();
 265   1        wait_ancho();
 266   1        wait_ancho();
 267   1        bus_clk=1;
 268   1        wait_ancho();
 269   1        wait_ancho();
 270   1      }
 271          
 272          //********************************************************************************************************
             -******
 273          bit tx_bus (unsigned char num_chr)
 274          {
 275   1          unsigned char j;
 276   1        long int cont;
 277   1        bit timeOut;
 278   1      
 279   1        bus_clk=1;            // Asegura pulso de Clk en 1
 280   1        timeOut=0;            // Borra Bandera de Time Out
 281   1        busy=0;             // Genera Peticion de Atencion al Secundario
 282   1        cont=T_MS*200;          // 500 ms  cambio echo jp 100 por 200
 283   1      //----------------------------------------
 284   1        while ((ready==1)&&(timeOut==0))
 285   1        {
 286   2          cont--;
 287   2          if (cont==0)
 288   2          {
 289   3            timeOut=1;
 290   3            bus_clk=1;
 291   3            ready=1;
 292   3            busy=1;
 293   3          }
 294   2        }
 295   1      //---------------------------------------
 296   1          if (timeOut==0)
 297   1        {
 298   2          for (j=0; j<num_chr; j++)
 299   2          {
 300   3              P2=buffer_bus[j];
 301   3            Pulso_Bus();
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 6   

 302   3          }
 303   2      
 304   2        }
 305   1      //---------------------------------------
 306   1        bus_clk=1;
 307   1      //  ready=1;
 308   1        busy=1;
 309   1        
 310   1        if (timeOut==0)
 311   1        {
 312   2          wait_long();
 313   2          wait_long();
 314   2          wait_long();
 315   2          wait_long();
 316   2      //    wait_long();
 317   2        }
 318   1        return timeOut;
 319   1      }
 320          
 321          //********************************************************************************************************
             -******
 322          
 323          //********************************************************************************************************
             -******
 324          //*******************************************************************************************
 325          void send_dataCLK(unsigned char fc, dir)
 326          {
 327   1        unsigned int valor;
 328   1        unsigned char centena, decena, unidad;
 329   1        valor=0;
 330   1      
 331   1        centena=0;
 332   1        decena=0;
 333   1        unidad=0;
 334   1         
 335   1        while (fc>=0x064)         // resto 100
 336   1        {
 337   2          fc=fc-0x64;
 338   2          centena=centena+1;
 339   2        }
 340   1        while (fc>=0x0a)        // resto 10
 341   1        {
 342   2          fc=fc-0x0a;
 343   2          decena=decena+1;
 344   2        }
 345   1        unidad=fc;
 346   1      
 347   1      //  vdato(centena|0x30);
 348   1        g_scArrTxComSoft[dir]=(decena|0x30);
 349   1          g_scArrTxComSoft[dir+1]=(unidad|0x30);
 350   1      }
 351          
 352          //********************************************************************************************************
             -******
 353          void relevos_aux(void)
 354          {
 355   1        (audio1==1)?(msg1=1):(msg1=0);
 356   1        (audio2==1)?(msg2=1):(msg2=0);
 357   1        (audio3==1)?(msg3=1):(msg3=0);
 358   1        (audio4==1)?(msg4=1):(msg4=0);
 359   1      }
 360          //********************************************************************************************************
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 7   

             -******
 361          //********************************************************************************************
 362          void rx_bus (void)
 363          {
 364   1        long int count;
 365   1        unsigned char timeOut,j=0;
 366   1      
 367   1      
 368   1        
 369   1        busy=1;
 370   1        num_data=0;
 371   1        if (ready==0)
 372   1        {
 373   2          timeOut=0;
 374   2          busy=0;
 375   2          for (j=0; j<MAX_CHR; j++)
 376   2          {                  //100000
 377   3            count=60;
 378   3            while ((bus_clk==1)&&(ready==0)&&(timeOut==0))
 379   3            {
 380   4              count--;
 381   4              if (count==0)
 382   4              {
 383   5                timeOut=1;
 384   5                j=MAX_CHR+1;
 385   5              }   
 386   4            }  
 387   3            if ((bus_clk==0)&&(timeOut==0)&&(ready==0))
 388   3            {
 389   4              buffer_bus[j]=P2;
 390   4              num_data++; 
 391   4              count=35;       //50000
 392   4              while ((bus_clk==0)&&(timeOut==0))
 393   4              {
 394   5                buffer_bus[j]=P2;
 395   5                count--;
 396   5                if (count==0)
 397   5                {
 398   6                  timeOut=1;
 399   6                  j=MAX_CHR+1;
 400   6                }       
 401   5              }
 402   4            }
 403   3            if (ready==1)
 404   3            {
 405   4              j=MAX_CHR+1;
 406   4            }
 407   3          }
 408   2          }
 409   1        busy=1;    
 410   1      
 411   1      }
 412          
 413          //********************************************************************************************************
             -******//**************************************************************************************************************
 414          //*******************************************************************************************
 415          //    FUNCIONES PARA VISUALIZAR FECHA HORA                        *
 416          //*******************************************************************************************
 417           void vdata_clk (unsigned char data_clk) 
 418           {
 419   1       
 420   1       unsigned int temp;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 8   

 421   1      
 422   1       temp=data_clk;
 423   1       temp=temp & 0xf0;
 424   1       temp>>=4;
 425   1       temp=temp|0x30;
 426   1       vdato(temp);
 427   1      
 428   1       temp=data_clk;
 429   1       temp=temp & 0x0f;
 430   1       temp=temp|0x30;
 431   1       vdato(temp);
 432   1      
 433   1      }
 434          
 435          //*******************************************************************************************
 436          void SendMsg(unsigned char tipo)
 437          {
 438   1        unsigned char i;
 439   1      
 440   1      
 441   1          buffer_bus[0]=STX;
 442   1          switch (tipo)
 443   1          {
 444   2            case GRACIAS:
 445   2              buffer_bus[1]='V';      
 446   2        
 447   2            break;
 448   2        
 449   2        
 450   2            case BIENVENIDO:
 451   2              buffer_bus[1]='O';
 452   2         
 453   2            break;
 454   2          }
 455   1         
 456   1          for(i=21; i<=37; i++)
 457   1          {
 458   2            buffer_bus[i-19]=g_scArrRxComSoft[i];
 459   2          }
 460   1          buffer_bus[18]=ETX;
 461   1          
 462   1          
 463   1      
 464   1          if (ready==1)
 465   1          {
 466   2            ErrorTx=tx_bus(19);
 467   2            if (ErrorTx==1)
 468   2            {
 469   3              for (i=0; i<19; i++)
 470   3              {
 471   4                BufferRetry[i]=buffer_bus[i];
 472   4              }
 473   3              NumDatRetry=19;
 474   3              TimeRetryCmd=cte_seg;
 475   3            }
 476   2          }
 477   1          else
 478   1          {
 479   2            for (i=0; i<19; i++)
 480   2            {
 481   3              BufferRetry[i]=buffer_bus[i];
 482   3            }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 9   

 483   2            NumDatRetry=19;
 484   2            TimeRetryCmd=cte_seg;
 485   2            
 486   2          }
 487   1      
 488   1                    
 489   1      
 490   1      }
 491          //********************************************************************************************************
             -******
 492          void SendRtaBus (unsigned char Respuesta)
 493          {
 494   1        if (ready==1)
 495   1        {
 496   2          /*modifica jaime coloca un delay*/
 497   2          wait_long();
 498   2          buffer_bus[0]=Respuesta;    
 499   2          ErrorTx=tx_bus(1);
 500   2          if (ErrorTx==1)
 501   2          {
 502   3            NumDatRetry=1;
 503   3            BufferRetry[0]=Respuesta;
 504   3            TimeRetryCmd=cte_retry;
 505   3          }     
 506   2        }
 507   1        else
 508   1        {
 509   2          NumDatRetry=1;
 510   2          BufferRetry[0]=Respuesta;
 511   2          TimeRetryCmd=cte_retry;
 512   2        } 
 513   1      }
 514          //********************************************************************************************************
             -******
 515          //
 516          //********************************************************************************************************
             -******
 517          void AtencComSoft(void)
 518          {
 519   1      static unsigned char cont_solocita_evn=0;
 520   1        char i, longTx;
 521   1        switch (g_cEstadoComSoft)
 522   1        {
 523   2      //********************************************************************************************************
             -******
 524   2          case POLL_COM_SOF:
 525   2      //--------------------------------------------------------------------------------------------------------
             -------
 526   2      //  COLOCAR BUFER DE TRANSMICION INDEPENDIENTE PARA CADA SITUACION
 527   2      //--------------------------------------------------------------------------------------------------------
             -------
 528   2            if (g_cEstadoTxSoft==SIN_LECTURA_TX)
 529   2            {       
 530   3              tx_chr(EOT);                        //No hay Novedad 
 531   3              g_cEstadoComSoft=ESPERA_RX;
 532   3              
 533   3              if (SignalAcceso==1)
 534   3              { 
 535   4                /*mora el sensor1 si esta en 0 no envia AA*/
 536   4                if(cont_solocita_evn==3)
 537   4                {
 538   5                buffer_bus[0]=SOLICITA_EVN;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 10  

 539   5                tx_bus(1);
 540   5                  cont_solocita_evn=0;
 541   5                }
 542   4                cont_solocita_evn++;
 543   4              }   
 544   3              
 545   3            }
 546   2      //--------------------------------------------------------------------------------------------------------
             -------
 547   2            else if ((g_cEstadoTxSoft&LECTURA_COD_TX)==LECTURA_COD_TX)          //Lectura Cod Barras
 548   2            {
 549   3                
 550   3              if (Tiquete_Placa==1)
 551   3              {
 552   4                longTx=0;
 553   4                g_scArrTxComSoft[longTx++]=STX;
 554   4                (send_markCashierAut==0)?(g_scArrTxComSoft[longTx++]='a'):(g_scArrTxComSoft[longTx++]='C');
 555   4                
 556   4                for (i=0; i<NumChrTicket; i++)
 557   4                  {
 558   5                  g_scArrTxComSoft[longTx++]=buffer_ticket[i];
 559   5                  }
 560   4                g_scArrTxComSoft[longTx++]=',';
 561   4                if (Tiquete_Salida==1)
 562   4                {
 563   5                  g_scArrTxComSoft[longTx++]=Cod_Dcto;
 564   5                }
 565   4                else
 566   4                {
 567   5                  g_scArrTxComSoft[longTx++]='0';
 568   5                }
 569   4                
 570   4                
 571   4                if (OrigenTipoVeh==CARD)
 572   4                {
 573   5                  if (Tipo_Vehiculo=='H')         // Heavy
 574   5                  {
 575   6                    g_scArrTxComSoft[longTx++]='0';   // Carro=0
 576   6                  }
 577   5                  else if (Tipo_Vehiculo=='T')      // Truck
 578   5                  {
 579   6                    g_scArrTxComSoft[longTx++]='0';   // Carro=0
 580   6                  }
 581   5                  else if(Tipo_Vehiculo=='M')       // Motocycle
 582   5                  {
 583   6                    g_scArrTxComSoft[longTx++]='1';   // Moto=1
 584   6                  }
 585   5                  else if(Tipo_Vehiculo=='C')       // Carro
 586   5                  {
 587   6                    g_scArrTxComSoft[longTx++]='0';   // Carro=0      modifica 24/01/2019    no  funciono
 588   6                  }
 589   5                  else
 590   5                  {
 591   6                    
 592   6                    if (Dif_Mot_Car==1)
 593   6                    {
 594   7                      if (automovil==0)
 595   7                      {
 596   8                        if(SignalAcceso==0)              //  Se modifica 24/01/2019
 597   8                        {
 598   9                        g_scArrTxComSoft[longTx++]='0';       // Carro=0  
 599   9                        }else { g_scArrTxComSoft[longTx++]='1';}    // Moto=1
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 11  

 600   8                      }    
 601   7                      else
 602   7                      {
 603   8                        g_scArrTxComSoft[longTx++]='1';   // Moto=1
 604   8                      }
 605   7                    }
 606   6                    else
 607   6                    {
 608   7                      g_scArrTxComSoft[longTx++]='0';   // Carro=0     modificado 24/01/2019
 609   7                    }
 610   6                    
 611   6                  }
 612   5                }
 613   4                else
 614   4                {
 615   5      
 616   5                    if (Dif_Mot_Car==1)
 617   5                    {
 618   6                      if (automovil==0)
 619   6                      {
 620   7                        if(SignalAcceso==0)              //  Se modifica 24/01/2019
 621   7                        {
 622   8                        g_scArrTxComSoft[longTx++]='0';   // Carro=0  modificado jp 24/01/2019   no funciona
 623   8                        }else { g_scArrTxComSoft[longTx++]='1';}
 624   7                      }
 625   6                      else
 626   6                      {
 627   7                        g_scArrTxComSoft[longTx++]='1';   // Moto=1
 628   7                      }
 629   6                    }
 630   5                    else
 631   5                    {
 632   6                      g_scArrTxComSoft[longTx++]='0';   // Carro=0     modificado jp 24/01/2019 nofunciona
 633   6                    }
 634   5                }
 635   4                
 636   4      
 637   4                g_scArrTxComSoft[longTx++]=',';
 638   4      
 639   4                send_dataCLK((YearIn-0x30),longTx);
 640   4                longTx=longTx+2;
 641   4                send_dataCLK((MonthIn-0x30),longTx);
 642   4                longTx=longTx+2;
 643   4                send_dataCLK((DayIn-0x30),longTx);
 644   4                longTx=longTx+2;
 645   4                send_dataCLK((HourIn-0x30),longTx);
 646   4                longTx=longTx+2;
 647   4                send_dataCLK((MinutIn-0x30),longTx);
 648   4                longTx=longTx+2;
 649   4      
 650   4                
 651   4                if (send_markCashierAut==0)
 652   4                {
 653   5                  g_scArrTxComSoft[longTx++]=',';
 654   5                  if (Tiquete_Salida==1)
 655   5                  {
 656   6        
 657   6                    send_dataCLK((YearOut-0x30),longTx);
 658   6                    longTx=longTx+2;
 659   6                    send_dataCLK((MonthOut-0x30),longTx);
 660   6                    longTx=longTx+2;
 661   6                    send_dataCLK((DayOut-0x30),longTx);
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 12  

 662   6                    longTx=longTx+2;
 663   6                    send_dataCLK((HourOut-0x30),longTx);
 664   6                    longTx=longTx+2;
 665   6                    send_dataCLK((MinutOut-0x30),longTx);
 666   6                    longTx=longTx+2;
 667   6                    g_scArrTxComSoft[longTx++]=',';
 668   6        
 669   6                    g_scArrTxComSoft[longTx++]=' ';
 670   6        
 671   6                    g_scArrTxComSoft[longTx++]=',';
 672   6                    g_scArrTxComSoft[longTx++]=ETX;         
 673   6                    EscribirCadenaSoft(longTx);     
 674   6        
 675   6                  }
 676   5                  else
 677   5                  {
 678   6                    g_scArrTxComSoft[longTx++]='0';
 679   6                    g_scArrTxComSoft[longTx++]='0';
 680   6                    g_scArrTxComSoft[longTx++]='0';
 681   6                    g_scArrTxComSoft[longTx++]='0';
 682   6                    g_scArrTxComSoft[longTx++]='0';
 683   6                    g_scArrTxComSoft[longTx++]='0';
 684   6                    g_scArrTxComSoft[longTx++]='0';
 685   6                    g_scArrTxComSoft[longTx++]='0';
 686   6                    g_scArrTxComSoft[longTx++]='0';
 687   6                    g_scArrTxComSoft[longTx++]='0';
 688   6        
 689   6                    g_scArrTxComSoft[longTx++]=',';
 690   6                    for (i=0; i<Num_Char_LPR; i++)
 691   6                    {
 692   7                      g_scArrTxComSoft[longTx++]=buffer_placa[i];
 693   7                    }
 694   6                    g_scArrTxComSoft[longTx++]=',';
 695   6                    g_scArrTxComSoft[longTx++]=ETX;         
 696   6                    EscribirCadenaSoft(longTx);     
 697   6                  }
 698   5      
 699   5                }
 700   4                else
 701   4                {
 702   5                  g_scArrTxComSoft[longTx++]=ETX;
 703   5                  EscribirCadenaSoft(longTx);
 704   5                }
 705   4          
 706   4      
 707   4              }
 708   3              else
 709   3              {
 710   4                g_scArrTxComSoft[0]=STX;
 711   4                
 712   4                if (Rechazo==0)
 713   4                {
 714   5                  (send_markCashierAut==0)?(g_scArrTxComSoft[1]='A'):(g_scArrTxComSoft[1]='C');
 715   5                }
 716   4                else
 717   4                {
 718   5                  g_scArrTxComSoft[1]=Rechazo;
 719   5                }
 720   4                
 721   4                
 722   4                longTx=len_buffer;
 723   4                for (i=0; i<len_buffer; i++)
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 13  

 724   4                  {
 725   5                  g_scArrTxComSoft[i+2]=buffer_ticket[i];
 726   5                  }
 727   4                g_scArrTxComSoft[longTx+2]=',';
 728   4        //--------------------------------------------------------------------
 729   4                if (Flag_Dcto==1)
 730   4                {
 731   5                  g_scArrTxComSoft[longTx+3]=Cod_Dcto;
 732   5                }
 733   4                else
 734   4                {         
 735   5                  g_scArrTxComSoft[longTx+3]='0';
 736   5                }
 737   4        //-------------------------------------------------------------------------------
 738   4                if (Send_Tipo_Veh==CARD)
 739   4                {
 740   5                  if (Tipo_Vehiculo=='H')         // Heavy
 741   5                  {
 742   6                    xTipo_Vehiculo=4;
 743   6                  }
 744   5                  else if (Tipo_Vehiculo=='T')      // Truck
 745   5                  {
 746   6                    xTipo_Vehiculo=3;
 747   6                  }
 748   5                  else if(Tipo_Vehiculo=='B')         // Bycicle
 749   5                  {
 750   6                    xTipo_Vehiculo=2;
 751   6                  }
 752   5                  else if(Tipo_Vehiculo=='M')       // Motocycle
 753   5                  {
 754   6                    xTipo_Vehiculo=1;
 755   6                  }
 756   5                  else if(Tipo_Vehiculo=='C')       // Carro
 757   5                  {
 758   6                    xTipo_Vehiculo=0;
 759   6                  }
 760   5                  else                  // Sin categoria
 761   5                  {
 762   6        
 763   6                    if (Dif_Mot_Car==1)
 764   6                    {
 765   7                      if (automovil==0)
 766   7                      {
 767   8                        xTipo_Vehiculo=0;     //Carro =0;
 768   8                      }
 769   7                      else
 770   7                      {
 771   8                        xTipo_Vehiculo=1;       //MOTO = 1
 772   8                      }
 773   7                    }
 774   6                    else
 775   6                    {
 776   7                      xTipo_Vehiculo=0;       //Carro =0;
 777   7                    }
 778   6                    
 779   6                  }
 780   5                  g_scArrTxComSoft[longTx+4]=xTipo_Vehiculo+0X30;
 781   5                }
 782   4                else
 783   4                {
 784   5                  if (Dif_Mot_Car==1)
 785   5                  {
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 14  

 786   6                    if (automovil==0)
 787   6                    {
 788   7                      g_scArrTxComSoft[longTx+4]='0';   //Carro =0;   modificado 23/01/2019 jp
 789   7                    }
 790   6                    else
 791   6                    {
 792   7                      g_scArrTxComSoft[longTx+4]='1';     //MOTO = 1
 793   7                    }
 794   6                  }
 795   5                  else
 796   5                  {
 797   6                    g_scArrTxComSoft[longTx+4]='0';   //Carro =0;
 798   6                  }
 799   5                  }
 800   4        //--------------------------------------------------------------------------------          
 801   4                if (send_markCashierAut==1)
 802   4                {
 803   5                  g_scArrTxComSoft[longTx+5]=',';
 804   5        
 805   5                  longTx=longTx+6;
 806   5                  send_dataCLK((YearIn-0x30),longTx);
 807   5                  longTx=longTx+2;
 808   5                  send_dataCLK((MonthIn-0x30),longTx);
 809   5                  longTx=longTx+2;
 810   5                  send_dataCLK((DayIn-0x30),longTx);
 811   5                  longTx=longTx+2;
 812   5                  send_dataCLK((HourIn-0x30),longTx);
 813   5                  longTx=longTx+2;
 814   5                  send_dataCLK((MinutIn-0x30),longTx);
 815   5                  longTx=longTx+2;
 816   5                  g_scArrTxComSoft[longTx]=ETX;
 817   5                  EscribirCadenaSoft(longTx+1);
 818   5        
 819   5        //          g_scArrTxComSoft[longTx+6]=YearIn;    
 820   5        //          g_scArrTxComSoft[longTx+7]=MonthIn;   
 821   5        //          g_scArrTxComSoft[longTx+8]=DayIn;   
 822   5        //          g_scArrTxComSoft[longTx+9]=HourIn;    
 823   5        //          g_scArrTxComSoft[longTx+10]=MinutIn;    
 824   5        //          g_scArrTxComSoft[longTx+11]=ETX;    
 825   5        //            EscribirCadenaSoft(longTx+12);
 826   5           
 827   5                }
 828   4                else
 829   4                {
 830   5                  g_scArrTxComSoft[longTx+5]=ETX;   
 831   5                    EscribirCadenaSoft(longTx+6);
 832   5        
 833   5                }
 834   4              }
 835   3              
 836   3              
 837   3      
 838   3      //        send_markCashierAut=0;
 839   3                g_cEstadoComSoft=ESPERA_RX;
 840   3            }
 841   2      //--------------------------------------------------------------------------------------------------------
             ----------
 842   2            else if ((g_cEstadoTxSoft&LECTURA_WIEG_TX)==LECTURA_WIEG_TX)        // Lectura Wiegand Lector 1
 843   2            {
 844   3                  Send_Wiegand=1;
 845   3                seg=cte_seg;
 846   3                TH0=0X00;                                           
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 15  

 847   3                TL0=0X00;
 848   3                TF0=0;
 849   3      
 850   3                if (Dato_OffLine==0)
 851   3                 {
 852   4                  if (SalidaW==1)
 853   4                  {
 854   5                    //SalidaW=0;
 855   5      //---------------------;
 856   5      
 857   5                  g_scArrTxComSoft[0]=STX;
 858   5                  g_scArrTxComSoft[1]='w';
 859   5                  g_scArrTxComSoft[2]=((buffer_wie[0]>>4)&0X0f)+0X30;
 860   5                  g_scArrTxComSoft[3]=(buffer_wie[0]&0X0F)+0X30;
 861   5                  g_scArrTxComSoft[4]=((buffer_wie[1]>>4)&0X0f)+0X30;
 862   5                  g_scArrTxComSoft[5]=(buffer_wie[1]&0X0f)+0X30;
 863   5                  g_scArrTxComSoft[6]=((buffer_wie[2]>>4)&0X0f)+0X30;
 864   5                  g_scArrTxComSoft[7]=(buffer_wie[2]&0X0f)+0X30;
 865   5        
 866   5                    g_scArrTxComSoft[8]=',';
 867   5                  g_scArrTxComSoft[9]='0';
 868   5        
 869   5      //-------------------------------------------------------------------------------
 870   5                  if (Send_Tipo_Veh==CARD)
 871   5                  {
 872   6                    if (Tipo_Vehiculo=='H')         // Heavy
 873   6                    {
 874   7                      xTipo_Vehiculo=4;
 875   7                    }
 876   6                    else if (Tipo_Vehiculo=='T')      // Truck
 877   6                    {
 878   7                      xTipo_Vehiculo=3;
 879   7                    }
 880   6                    else if(Tipo_Vehiculo=='B')         // Bycicle
 881   6                    {
 882   7                      xTipo_Vehiculo=2;
 883   7                    }
 884   6                    else if(Tipo_Vehiculo=='M')       // Motocycle
 885   6                    {
 886   7                      xTipo_Vehiculo=1;
 887   7                    }
 888   6                    else if(Tipo_Vehiculo=='C')       // Carro
 889   6                    {
 890   7                      xTipo_Vehiculo=0;
 891   7                    }
 892   6                    else                  // Sin categoria
 893   6                    {
 894   7          
 895   7                      if (Dif_Mot_Car==1)
 896   7                      {
 897   8                        if (automovil==0)
 898   8                        {
 899   9                          xTipo_Vehiculo=0;     //Carro =0;   modificado 23/01/2019   no funciona
 900   9                        }
 901   8                        else
 902   8                        {
 903   9                          xTipo_Vehiculo=1;       //MOTO = 1
 904   9                        }
 905   8                      }
 906   7                      else
 907   7                      {
 908   8                        xTipo_Vehiculo=0;       //Carro =0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 16  

 909   8                      }
 910   7                      
 911   7                    }
 912   6                    g_scArrTxComSoft[10]=xTipo_Vehiculo+0X30;
 913   6                  }
 914   5                  else
 915   5                  {
 916   6                    if (Dif_Mot_Car==1)
 917   6                    {
 918   7                      if (automovil==0)
 919   7                      {
 920   8                        g_scArrTxComSoft[10]='0';   //Carro =0;   no funcionamodificado 23/01/2019
 921   8                      }
 922   7                      else
 923   7                      {
 924   8                        g_scArrTxComSoft[10]='1';     //MOTO = 1
 925   8                      }
 926   7                    }
 927   6                    else
 928   6                    {
 929   7                      g_scArrTxComSoft[10]='0';     //Carro =0;
 930   7                    }
 931   6                    }
 932   5      //--------------------------------------------------------------------------------  
 933   5                      g_scArrTxComSoft[11]=',';
 934   5                  
 935   5      
 936   5                  send_dataCLK((YearIn-0x30),12);
 937   5                  send_dataCLK((MonthIn-0x30),14);
 938   5                  send_dataCLK((DayIn-0x30),16);
 939   5                  send_dataCLK((HourIn-0x30),18);
 940   5                  send_dataCLK((MinutIn-0x30),20);
 941   5      
 942   5                    
 943   5                    g_scArrTxComSoft[22]=',';
 944   5                  send_dataCLK((YearOut-0x30),23);
 945   5                  send_dataCLK((MonthOut-0x30),25);
 946   5                  send_dataCLK((DayOut-0x30),27);
 947   5                  send_dataCLK((HourOut-0x30),29);
 948   5                  send_dataCLK((MinutOut-0x30),31);
 949   5                  temp=33;
 950   5                  g_scArrTxComSoft[temp++]=',';
 951   5                    
 952   5                    if (Dato_Placa==1)
 953   5                    {
 954   6      //                Dato_Placa=0;
 955   6      //                for (i=0; i<NumDatosPlate-1; i++)
 956   6                      for (i=0; i<NumDatosPlate; i++)
 957   6                      {
 958   7                        g_scArrTxComSoft[temp++]=buffer_placa[i];
 959   7                      }
 960   6                      }
 961   5                    else
 962   5                    {
 963   6                        g_scArrTxComSoft[temp++]=' ';
 964   6                    }
 965   5                    g_scArrTxComSoft[temp++]=',';
 966   5                    g_scArrTxComSoft[temp++]=ETX;
 967   5                    EscribirCadenaSoft(temp);
 968   5      
 969   5      
 970   5      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 17  

 971   5      
 972   5      //---------------------
 973   5                  }
 974   4                  else
 975   4                  {
 976   5                    g_scArrTxComSoft[0]=STX;
 977   5                    g_scArrTxComSoft[1]='B';
 978   5                    g_scArrTxComSoft[2]=((buffer_wie[0]>>4)&0X0f)+0X30;
 979   5                    g_scArrTxComSoft[3]=(buffer_wie[0]&0X0F)+0X30;
 980   5                    g_scArrTxComSoft[4]=((buffer_wie[1]>>4)&0X0f)+0X30;
 981   5                    g_scArrTxComSoft[5]=(buffer_wie[1]&0X0f)+0X30;
 982   5                    g_scArrTxComSoft[6]=((buffer_wie[2]>>4)&0X0f)+0X30;
 983   5                    g_scArrTxComSoft[7]=(buffer_wie[2]&0X0f)+0X30;
 984   5          
 985   5                      g_scArrTxComSoft[8]=',';
 986   5                    g_scArrTxComSoft[9]='0';
 987   5          
 988   5                    if (Dif_Mot_Car==1)
 989   5                    {
 990   6                      if (automovil==0)
 991   6                      {
 992   7                        g_scArrTxComSoft[10]='0';   //Carro =0;
 993   7                      }
 994   6                      else
 995   6                      {
 996   7                        g_scArrTxComSoft[10]='1';     //MOTO = 1
 997   7                      }
 998   6                    }
 999   5                    else
1000   5                    {
1001   6                      g_scArrTxComSoft[10]='0';     //Carro =0;
1002   6                    }
1003   5          
1004   5                    g_scArrTxComSoft[11]=ETX;
1005   5                    EscribirCadenaSoft(12);
1006   5      
1007   5                  }
1008   4                  
1009   4      
1010   4      
1011   4                }
1012   3                else
1013   3                {
1014   4      
1015   4                  g_scArrTxComSoft[0]=STX;
1016   4                  g_scArrTxComSoft[1]='w';
1017   4                  g_scArrTxComSoft[2]=((buffer_wie[0]>>4)&0X0f)+0X30;
1018   4                  g_scArrTxComSoft[3]=(buffer_wie[0]&0X0F)+0X30;
1019   4                  g_scArrTxComSoft[4]=((buffer_wie[1]>>4)&0X0f)+0X30;
1020   4                  g_scArrTxComSoft[5]=(buffer_wie[1]&0X0f)+0X30;
1021   4                  g_scArrTxComSoft[6]=((buffer_wie[2]>>4)&0X0f)+0X30;
1022   4                  g_scArrTxComSoft[7]=(buffer_wie[2]&0X0f)+0X30;
1023   4        
1024   4                    g_scArrTxComSoft[8]=',';
1025   4                  g_scArrTxComSoft[9]='0';
1026   4        
1027   4      //-------------------------------------------------------------------------------
1028   4                  if (Send_Tipo_Veh==CARD)
1029   4                  {
1030   5                    if (Tipo_Vehiculo=='H')         // Heavy
1031   5                    {
1032   6                      xTipo_Vehiculo=4;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 18  

1033   6                    }
1034   5                    else if (Tipo_Vehiculo=='T')      // Truck
1035   5                    {
1036   6                      xTipo_Vehiculo=3;
1037   6                    }
1038   5                    else if(Tipo_Vehiculo=='B')         // Bycicle
1039   5                    {
1040   6                      xTipo_Vehiculo=2;
1041   6                    }
1042   5                    else if(Tipo_Vehiculo=='M')       // Motocycle
1043   5                    {
1044   6                      xTipo_Vehiculo=1;
1045   6                    }
1046   5                    else if(Tipo_Vehiculo=='C')       // Carro
1047   5                    {
1048   6                      xTipo_Vehiculo=0;
1049   6                    }
1050   5                    else                  // Sin categoria
1051   5                    {
1052   6          
1053   6                      if (Dif_Mot_Car==1)
1054   6                      {
1055   7                        if (automovil==0)
1056   7                        {
1057   8                          xTipo_Vehiculo=0;     //Carro =0;      no funciona modificado 23/01/2019
1058   8                        }
1059   7                        else
1060   7                        {
1061   8                          xTipo_Vehiculo=1;       //MOTO = 1
1062   8                        }
1063   7                      }
1064   6                      else
1065   6                      {
1066   7                        xTipo_Vehiculo=0;       //Carro =0;
1067   7                      }
1068   6                      
1069   6                    }
1070   5                    g_scArrTxComSoft[10]=xTipo_Vehiculo+0X30;
1071   5                  }
1072   4                  else
1073   4                  {
1074   5                    if (Dif_Mot_Car==1)
1075   5                    {
1076   6                      if (automovil==0)
1077   6                      {
1078   7                        g_scArrTxComSoft[10]='0';   //Carro =0;   no funcionamodificado 23/01/2019
1079   7                      }
1080   6                      else
1081   6                      {
1082   7                        g_scArrTxComSoft[10]='1';     //MOTO = 1
1083   7                      }
1084   6                    }
1085   5                    else
1086   5                    {
1087   6                      g_scArrTxComSoft[10]='0';     //Carro =0;
1088   6                    }
1089   5                    }
1090   4      //--------------------------------------------------------------------------------  
1091   4                      g_scArrTxComSoft[11]=',';
1092   4                  
1093   4      
1094   4                  send_dataCLK((YearIn-0x30),12);
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 19  

1095   4                  send_dataCLK((MonthIn-0x30),14);
1096   4                  send_dataCLK((DayIn-0x30),16);
1097   4                  send_dataCLK((HourIn-0x30),18);
1098   4                  send_dataCLK((MinutIn-0x30),20);
1099   4      
1100   4                  if (Off_Line_Salida==1)
1101   4                  {
1102   5                    
1103   5                      g_scArrTxComSoft[22]=',';
1104   5                    send_dataCLK((YearOut-0x30),23);
1105   5                    send_dataCLK((MonthOut-0x30),25);
1106   5                    send_dataCLK((DayOut-0x30),27);
1107   5                    send_dataCLK((HourOut-0x30),29);
1108   5                    send_dataCLK((MinutOut-0x30),31);
1109   5                    temp=33;
1110   5                    g_scArrTxComSoft[temp++]=',';
1111   5                    
1112   5                    if (Dato_Placa==1)
1113   5                    {
1114   6      //                Dato_Placa=0;
1115   6      //                for (i=0; i<NumDatosPlate-1; i++)
1116   6                      for (i=0; i<NumDatosPlate; i++)
1117   6                      {
1118   7                        g_scArrTxComSoft[temp++]=buffer_placa[i];
1119   7                      }
1120   6                      g_scArrTxComSoft[temp++]=',';
1121   6                      g_scArrTxComSoft[temp++]=ETX;
1122   6                      EscribirCadenaSoft(temp);
1123   6      
1124   6                    }
1125   5                    else
1126   5                    {
1127   6                        g_scArrTxComSoft[temp++]=' ';
1128   6                      g_scArrTxComSoft[temp++]=',';
1129   6                        g_scArrTxComSoft[temp++]=ETX;
1130   6                      EscribirCadenaSoft(temp);
1131   6                    }
1132   5      
1133   5      //              g_scArrTxComSoft[33]=ETX;
1134   5      //              EscribirCadenaSoft(34);
1135   5                  }
1136   4                  else
1137   4                  {
1138   5                      g_scArrTxComSoft[22]=',';
1139   5                    send_dataCLK((0),23);
1140   5                    send_dataCLK((0),25);
1141   5                    send_dataCLK((0),27);
1142   5                    send_dataCLK((0),29);
1143   5                    send_dataCLK((0),31);
1144   5      
1145   5                    temp=33;
1146   5                    g_scArrTxComSoft[temp++]=',';
1147   5                    
1148   5                    if (Dato_Placa==1)
1149   5                    {
1150   6                      Dato_Placa=0;
1151   6                      for (i=0; i<NumDatosPlate-1; i++)
1152   6                      {
1153   7                        g_scArrTxComSoft[temp++]=buffer_placa[i];
1154   7                      }
1155   6                      g_scArrTxComSoft[temp++]=',';
1156   6                      g_scArrTxComSoft[temp++]=ETX;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 20  

1157   6                      EscribirCadenaSoft(temp);
1158   6                    }
1159   5                    else
1160   5                    {
1161   6                        g_scArrTxComSoft[temp++]=' ';
1162   6                      g_scArrTxComSoft[temp++]=',';
1163   6                        g_scArrTxComSoft[temp++]=ETX;
1164   6                      EscribirCadenaSoft(temp);
1165   6                    }
1166   5      
1167   5      //              g_scArrTxComSoft[33]=ETX;
1168   5      //              EscribirCadenaSoft(34);
1169   5      
1170   5                  }
1171   4      
1172   4                }
1173   3      
1174   3      //          g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1175   3      //jp          byte_wie=0x00000000;
1176   3      //          nbitsW=0;
1177   3                g_cEstadoComSoft=ESPERA_RX;
1178   3            }
1179   2      //--------------------------------------------------------------------------------------------------------
             ----------      
1180   2              else if ((g_cEstadoTxSoft&COD_PRINT_TX)==COD_PRINT_TX)            // Envia Ticket/Impresora
1181   2            {
1182   3              g_cEstadoTxSoft &=~COD_PRINT_TX;
1183   3              g_cEstadoComSoft=ESPERA_RX;
1184   3            } 
1185   2      //--------------------------------------------------------------------------------------------------------
             ----------
1186   2          break;
1187   2      //********************************************************************************************************
             -*********
1188   2      //********************************************************************************************************
             -*********
1189   2          case ANALICE_STR_SOF:                                //ANALIZA DATOS RECIBIDOS
1190   2      
1191   2                g_scArrDisplay[g_cContByteRx]=0;
1192   2              
1193   2                if (SerieOK==1)
1194   2              {
1195   3                SerieOK=0;
1196   3                for (i=0; i<g_cContByteRx; i++)
1197   3                {
1198   4                  buffer_bus[i]=g_scArrDisplay[i];
1199   4                }
1200   3                
1201   3                tx_bus(g_cContByteRx);
1202   3                txACK=1;
1203   3                g_cEstadoComSoft=ESPERA_RX;
1204   3              }                                       
1205   2      //--------------------------------------------------------------------------------------------------------
             --------
1206   2      //        else if((g_cContByteRx==25)&&(g_scArrRxComSoft[1]==g_cDirBoard)&&(g_scArrRxComSoft[2]=='H'))  //H: HO
             -RA DEL SISTEMA
1207   2              else if((g_cContByteRx==25)&&(g_scArrDisplay[1]==g_cDirBoard)&&(g_scArrDisplay[2]=='H'))    //H: HORA DE
             -L SISTEMA
1208   2              { 
1209   3                  prg_disp();
1210   3                  for (i=0; i<g_cContByteRx; i++)
1211   3                  {
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 21  

1212   4                    buffer_bus[i]=g_scArrDisplay[i];
1213   4                  }
1214   3                  
1215   3                  backup_clk();
1216   3              
1217   3                
1218   3                  cont(0x80);
1219   3                  vdato('S');
1220   3                  vdato('Y');
1221   3                  vdato('N');
1222   3                  vdato('C');
1223   3                  txACK=1;
1224   3                  g_cEstadoComSoft=ESPERA_RX;
1225   3      
1226   3              }
1227   2              else if(g_cContByteRx>=0x06)            //Area de Actuadores
1228   2              {
1229   3                /*envia los cupos al segundario*/
1230   3                if(g_cContByteRx>=0x07)               // modificado jp cmd del num de cupos disponibles
1231   3                 {  
1232   4                  if(g_scArrRxComSoft[1]=='c')      // valido el cmd de cupos q es 'c'
1233   4                  {
1234   5                    
1235   5                  tx_bus(g_cContByteRx);
1236   5                /*
1237   5                    cont(0x80);                         //se envia inf al lcd para pruebas
1238   5                    buffer_Cupo[4]='\0';
1239   5                   lcd_text(0,0,(unsigned char *)  buffer_Cupo);
1240   5                    */
1241   5                    txACK=1;
1242   5                    g_cEstadoComSoft=ESPERA_RX;
1243   5                  }
1244   4                }
1245   3                
1246   3                if(g_scArrRxComSoft[1]=='D')
1247   3                {
1248   4      
1249   4                }
1250   3                else if(g_scArrRxComSoft[1]=='A')
1251   3                {
1252   4      //            lock1=1;
1253   4      //            seg=cte_seg;
1254   4      //            TH0=0X00;                                           
1255   4      //            TL0=0X00;
1256   4      //            TF0=0;        
1257   4                }
1258   3                if(g_scArrRxComSoft[2]=='D')
1259   3                {
1260   4      
1261   4                }
1262   3                else if(g_scArrRxComSoft[2]=='A')
1263   3                {
1264   4                  if (notifyEVP==1)
1265   4                  {
1266   5                    if (InhabilitaPulsoEvPOut==1)
1267   5                    {
1268   6                      if ((Send_Wiegand==1))
1269   6                      {
1270   7                        if (SalidaW==0)
1271   7                        {
1272   8                          lock2=1;            // Alvaro Manda Abrir mensual y tiquete pero notifico
1273   8                          seg=cte_seg+14;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 22  

1274   8                          TH0=0X00;           //Inicializa timer                    *           
1275   8                          TL0=0X00;
1276   8                          TF0=0;
1277   8                        }
1278   7                      }
1279   6                    }
1280   5                    else
1281   5                    {
1282   6                      if (SalidaW==0)
1283   6                      {
1284   7                        lock2=1;              // Alvaro Manda Abrir mensual y tiquete pero notifico
1285   7                        seg=cte_seg+14;
1286   7                        TH0=0X00;             //Inicializa timer                    *           
1287   7                        TL0=0X00;
1288   7                        TF0=0;
1289   7                        }
1290   6                    }
1291   5      
1292   5                  }
1293   4                }
1294   3      //--------------------------------------------------------------------------------------------------------
             --------------------*
1295   3                if (bandera_rx_soft==1)                 //(g_cContByteRx>0x06)                          //Area de Mensajes L1       
1296   3                {
1297   4                  bandera_rx_soft=0;
1298   4      
1299   4                  if ((g_scArrDisplay[5]=='A')&&(g_scArrDisplay[6]=='C')&&(g_scArrDisplay[7]=='E')&&(g_scArrDisplay[8]
             -=='R')&&(g_scArrDisplay[9]=='Q')&&(g_scArrDisplay[10]=='U')&&(g_scArrDisplay[11]=='E')&&(g_scArrDisplay[12]=='S')&&(g_sc
             -ArrDisplay[13]=='E'))
1300   4                  {
1301   5                    SendRtaBus(0xa1);
1302   5                  }
1303   4                    else if ((g_scArrDisplay[5]=='U')&&(g_scArrDisplay[6]=='N')&&(g_scArrDisplay[7]==' ')&&(g_scArrDi
             -splay[8]=='M'))
1304   4                  {
1305   5                    SendRtaBus(UN_MOMENTO);
1306   5                    
1307   5                    g_cEstadoTxSoft &=~LECTURA_COD_TX;
1308   5                    g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1309   5                    Dato_Placa=0;
1310   5      
1311   5                    Tiquete_Placa=0;
1312   5                    Tiquete_Salida=0;
1313   5                    send_markCashierAut=0;
1314   5      
1315   5                    Rechazo=0;
1316   5                    TimeOut_Codigo=0;
1317   5                    TimeOut_Wiegand=0;
1318   5                    SalidaW=0;
1319   5                    Tipo_Vehiculo=' ';
1320   5                    
1321   5                  }
1322   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='A')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='G')&&(g_scArrDisplay[6]=='R')&&(g_scArrDisplay[7]=='A')&&(g_scArrDisplay[8]=='C')&&
             -(g_scArrDisplay[9]=='I')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='S'))
1323   4                  {
1324   5                    SendMsg(GRACIAS);
1325   5                    }
1326   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='B')&&(g_scArrDisplay[6]=='I')&&(g_scArrDisplay[7]=='E')&&(g_scArrDisplay[8]=='N')&&
             -(g_scArrDisplay[9]=='V')&&(g_scArrDisplay[10]=='E')&&(g_scArrDisplay[11]=='N')&&(g_scArrDisplay[12]=='I')&&(g_scArrDispl
             -ay[13]=='D')&&(g_scArrDisplay[14]=='O'))
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 23  

1327   4                  {
1328   5                    SendMsg(BIENVENIDO);
1329   5                  }
1330   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='N')&&(g_scArrDisplay[14]=='O')&&(g_scArrDisplay[15]==' ')&&(g_scArrDisplay[16]=='E')&&(g_scArrDisplay[17]=='S')
             -&&(g_scArrDisplay[18]=='T')&&(g_scArrDisplay[19]=='A'))
1331   4                  {
1332   5                    SendRtaBus(NO_IN_PARK);
1333   5                  }
1334   4      
1335   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='Y')&&(g_scArrDisplay[14]=='A')&&(g_scArrDisplay[15]==' ')&&(g_scArrDisplay[16]=='E')&&(g_scArrDisplay[17]=='S')
             -&&(g_scArrDisplay[18]=='T')&&(g_scArrDisplay[19]=='A'))
1336   4                  {
1337   5                    SendRtaBus(IN_PARK);
1338   5                  }
1339   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='F')&&(g_scArrDisplay[14]=='U')&&(g_scArrDisplay[15]=='E')&&(g_scArrDisplay[16]=='R')&&(g_scArrDisplay[17]=='A')
             -&&(g_scArrDisplay[18]==' ')&&(g_scArrDisplay[19]=='D')&&(g_scArrDisplay[20]=='E')&&(g_scArrDisplay[21]=='R'))
1340   4                  {
1341   5                    SendRtaBus(EXPIRO);
1342   5                  }
1343   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='F')&&(g_scArrDisplay[14]=='U')&&(g_scArrDisplay[15]=='E')&&(g_scArrDisplay[16]=='R')&&(g_scArrDisplay[17]=='A')
             -&&(g_scArrDisplay[18]==' ')&&(g_scArrDisplay[19]=='D')&&(g_scArrDisplay[20]=='E')&&(g_scArrDisplay[21]=='H'))
1344   4                  {
1345   5                    SendRtaBus(HORARIO);
1346   5                  }
1347   4                  else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDispl
             -ay[4]=='X')&&(g_scArrDisplay[5]=='N')&&(g_scArrDisplay[6]=='O')&&(g_scArrDisplay[7]==' ')&&(g_scArrDisplay[8]=='E')&&(g_
             -scArrDisplay[9]=='S')&&(g_scArrDisplay[10]==' ')&&(g_scArrDisplay[11]=='M')&&(g_scArrDisplay[12]=='E')&&(g_scArrDisplay[
             -13]=='N')&&(g_scArrDisplay[14]=='S'))
1348   4                  {
1349   5                    SendRtaBus(NO_MENSUAL);
1350   5                              
1351   5                  }
1352   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='N')&&(g_scArrDisplay[6]=='O')&&(g_scArrDisplay[7]==' ')&&(g_scArrDisplay[8]=='R')&&
             -(g_scArrDisplay[9]=='E')&&(g_scArrDisplay[10]=='G')&&(g_scArrDisplay[11]=='I')&&(g_scArrDisplay[12]=='S')&&(g_scArrDispl
             -ay[13]=='T')&&(g_scArrDisplay[14]=='R'))
1353   4                  {
1354   5                    SendRtaBus(NO_REGIST);
1355   5      
1356   5                  }
1357   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='L')&&(g_scArrDisplay[6]=='O')&&(g_scArrDisplay[7]=='T')&&(g_scArrDisplay[8]=='E')&&
             -(g_scArrDisplay[9]==' ')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='S')&&(g_scArrDisplay[12]=='I')&&(g_scArrDispl
             -ay[13]=='G')&&(g_scArrDisplay[14]=='N'))
1358   4                  {
1359   5                    SendRtaBus(LOT_FULL);
1360   5                  }
1361   4                  //
1362   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDisp
             -lay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&(g
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 24  

             -_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDisplay
             -[13]=='E')&&(g_scArrDisplay[14]=='X')&&(g_scArrDisplay[15]=='C')&&(g_scArrDisplay[16]=='E')&&(g_scArrDisplay[17]=='D')&&
             -(g_scArrDisplay[18]=='E'))
1363   4                  {
1364   5                    SendRtaBus(EXCEDE_HORARIO);
1365   5                  }
1366   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDisp
             -lay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&(g
             -_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDisplay
             -[13]=='N')&&(g_scArrDisplay[14]=='O')&&(g_scArrDisplay[15]==' ')&&(g_scArrDisplay[16]=='P')&&(g_scArrDisplay[17]=='A')&&
             -(g_scArrDisplay[18]=='G'))
1367   4                  {
1368   5                    SendRtaBus(MENSUAL_NO_PAGO);
1369   5                  }
1370   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDisp
             -lay[4]=='X')&&(g_scArrDisplay[5]=='N')&&(g_scArrDisplay[6]=='O')&&(g_scArrDisplay[7]==' ')&&(g_scArrDisplay[8]=='P')&&(g
             -_scArrDisplay[9]=='A')&&(g_scArrDisplay[10]=='G')&&(g_scArrDisplay[11]=='O'))
1371   4                  {
1372   5                    SendRtaBus(NO_PAGO);
1373   5                  }
1374   4      //--------------------------------------------------------------------------------------------------------
             ------------------
1375   4                  cont(0x80);
1376   4                  for(i=5;(i<21)&&(g_scArrDisplay[i]!=ETX);i++)     /*msj en el display ejemplo (PARQUEADERO)*/
1377   4                  {
1378   5                    vdato(g_scArrDisplay[i]);
1379   5                  }
1380   4                  cont(0xc0);
1381   4                  for(i=21;(i<=38)&&(g_scArrDisplay[i]!=ETX);i++)
1382   4                  {
1383   5                      if (msg_error==0)
1384   5                    {
1385   6                      vdato(g_scArrDisplay[i]);                     /*hora del sistema*/
1386   6                    }
1387   5                  }
1388   4      
1389   4                } //if(g_cContByteRx>0x06)       
1390   3      
1391   3      
1392   3              }
1393   2      //--------------------------------------------------------------------------------------------------------
             ------------------
1394   2              g_cEstadoComSoft=ESPERA_RX;
1395   2              txACK=1;
1396   2            
1397   2          break;
1398   2      //--------------------------------------------------------------------------------------------------------
             ----
1399   2          default:
1400   2            g_cEstadoComSoft=ESPERA_RX;
1401   2          break;
1402   2        
1403   2        }
1404   1      } 
1405          
1406          //*******************************************************************************************
1407          //
1408          //  Main C function that start the interrupt-driven serial I/O.
1409          //
1410          //*******************************************************************************************
1411          void main (void) 
1412          {
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 25  

1413   1      
1414   1       unsigned char MSGnotify    []= "COMPARACION:    " ;
1415   1       unsigned char msgdir       []= "   Addr:        " ;
1416   1       unsigned char sin_resp     []= " SIN RESPUESTA  " ; 
1417   1       unsigned char resp_NACK    []= " PLACA NO IGUAL " ; 
1418   1       unsigned char SendCode   []= " ENVIANDO DATOS " ; 
1419   1      
1420   1       unsigned char k,i,NumDatValidar;
1421   1       unsigned char PosComa[2];
1422   1       unsigned char temp;
1423   1      
1424   1      //******************************************************************************************* 
1425   1        com_initialize ();                  // Initialize interrupt driven serial I/O       *
1426   1        inicia_wiegand();                 // Inicia wiegand lectrua a 26 complemnto a uno, lectura a 33, 27 lectura a 26 
             -sin complemeto
1427   1       //   EA = 1;                             // Enable global interrupts             *
1428   1        prg_disp();
1429   1      //******************************************************************************************* 
1430   1        TMOD=(TMOD & 0xf0) | 0x01;      //  Coloca el temporizador 0 y 1 en modo 1.  16bITS *
1431   1        TF0=0;                //  Bandera de Timer                *
1432   1        TH0=0X00;             //                          *           
1433   1        TL0=0X00;             //                          *
1434   1        TR0=1;                // Run TM2                      *
1435   1      //******************************************************************************************* 
1436   1        lock1=0;              // Relevo                     *
1437   1        lock2=0;
1438   1        ledv=0;                 // Led Pulsador                   *
1439   1        bus_clk=1;
1440   1      //******************************************************************************************* 
1441   1      //  INICIALIZACIONES
1442   1      //*******************************************************************************************
1443   1      
1444   1      
1445   1        toggle=1;
1446   1        TimeOut_Codigo=0;
1447   1        TimeOut_Wiegand=0;
1448   1        TimeOutLinea=TIMEW;
1449   1        seg=cte_seg;
1450   1        retry=0;
1451   1      
1452   1        msg1=0;
1453   1        audio1=0;
1454   1      
1455   1        msg2=0;
1456   1        audio2=0;
1457   1      
1458   1        msg3=0;
1459   1        audio3=0;
1460   1      
1461   1        msg4=0;
1462   1        audio4=0;
1463   1      
1464   1        send_markCashierAut=0;
1465   1        Rechazo=0;
1466   1        Dato_OffLine=0;
1467   1        Tiquete_Placa=0;
1468   1        Tiquete_Salida=0;
1469   1        TimeRetryCmd=0;
1470   1        TimeOut_Send_Acceso=0;
1471   1        Tx_Acceso=0;
1472   1        iTimeEsperaRtaLPR=0;
1473   1        RetryCmd=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 26  

1474   1      //*******************************************************************************************
1475   1      //  PROGRAMACIONES
1476   1      //*******************************************************************************************
1477   1        ACCESO_USE_LPR=0;                   // 0 = Envia a Evp   1 = Envia al secundario LPR para Decision de Acceso
1478   1        notifyEVP=1;
1479   1        Dif_Mot_Car=1;
1480   1        OrigenTipoVeh=CARD;                 // CARD - LOOP
1481   1      
1482   1      
1483   1        InhabilitaPulsoEvPOut=1;                // Mifare Inhabilta Pulso de Evp...
1484   1                                  // Ticket NO debe Inhabilitar
1485   1        Send_Tipo_Veh=CARD;                 // CARD o LOOP
1486   1        OpenMensual_Apx=0;                  // 
1487   1        Central_ID_OFFLINE=0;
1488   1      //*******************************************************************************************
1489   1      
1490   1        lcd_text(0,0,(unsigned char *) " AccesScan v4.5 ");
1491   1      
1492   1        cont(0xc0);
1493   1        lcd_puts(msgdir);             /*jp se muestra la direccion*/
1494   1        ve_dir();
1495   1      //------------------------------------------------------------------------------------------*
1496   1        busy=1;
1497   1        bus_clk=1;
1498   1        if (automovil==1)
1499   1        {
1500   2          
1501   2        }
1502   1      //*******************************************************************************************
1503   1        while (1)
1504   1         {
1505   2      
1506   2            P2=0xff;
1507   2          temp=P2;
1508   2        
1509   2          if((completo == 1) &&(SignalAcceso==0))
1510   2          {
1511   3          
1512   3            if (Habilita_Lectura==1)
1513   3            {
1514   4              TimeOutLinea=TIMEW;             /*tengo el dato wiegand en el orden de access*/
1515   4                id_Access();                  /*tengo el dato en buffer_wie*/
1516   4              
1517   4              limpia_data();                /*limpio los datos*/        
1518   4                
1519   4              if ((ACCESO_USE_LPR==1))
1520   4              {
1521   5          
1522   5                if (iTimeEsperaRtaLPR==0)         /*envio trama para ser transmitida por tcp/ip*/
1523   5                {
1524   6                buffer_bus[0]=STX;
1525   6                buffer_bus[1]='W';
1526   6                buffer_bus[2]=buffer_wie[0];
1527   6                buffer_bus[3]=buffer_wie[1];
1528   6                buffer_bus[4]=buffer_wie[2];
1529   6                buffer_bus[5]=ETX;
1530   6        
1531   6                buffer_wieLPR[0]=buffer_wie[0];
1532   6                buffer_wieLPR[1]=buffer_wie[1];
1533   6                buffer_wieLPR[2]=buffer_wie[2];
1534   6        
1535   6                g_cContByteRx=6;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 27  

1536   6                tx_bus(g_cContByteRx);                  /*transmito al pto paralelo*/
1537   6                g_cEstadoTxSoft &=~LECTURA_WIEG_TX;     // Si usa LPR no envia al software. LPR agrega el registro y da
             - Acceso
1538   6                iTimeEsperaRtaLPR=cte_seg*20;
1539   6                }
1540   5                else
1541   5                {
1542   6                g_cEstadoTxSoft &=~LECTURA_WIEG_TX;     // Si usa LPR no envia al software. LPR agrega el registro y da
             - Acceso
1543   6                }
1544   5                
1545   5              }
1546   4              else
1547   4              {
1548   5              buffer_bus[0]=STX;
1549   5              buffer_bus[1]='W';
1550   5              buffer_bus[2]=buffer_wie[0];
1551   5              buffer_bus[3]=buffer_wie[1];
1552   5              buffer_bus[4]=buffer_wie[2];
1553   5              buffer_bus[5]=ETX;
1554   5              g_cContByteRx=6;
1555   5              tx_bus(g_cContByteRx);
1556   5              g_cEstadoTxSoft=LECTURA_WIEG_TX;
1557   5              SalidaW=0;
1558   5              TimeOut_Wiegand=5;
1559   5                g_cEstadoComSoft=POLL_COM_SOF;
1560   5                AtencComSoft();
1561   5              }
1562   4      
1563   4            } 
1564   3            else
1565   3            {
1566   4              lcd_text(1,0,(unsigned char *) "INHABILITADA... ");
1567   4              g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1568   4            }
1569   3      
1570   3      
1571   3              if (Central_ID_OFFLINE==1)
1572   3              {
1573   4                if (((buffer_wie[0]==0x76)&&(buffer_wie[1]==0xd6)&&(buffer_wie[2]==0x0b))||((buffer_wie[0]==0x24)&&(b
             -uffer_wie[1]==0x54)&&(buffer_wie[2]==0xe4))||((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x00)&&(buffer_wie[2]==0xd5))||((bu
             -ffer_wie[0]==0x5F)&&(buffer_wie[1]==0xd7)&&(buffer_wie[2]==0x84)))
1574   4                {
1575   5                  lock1=1;
1576   5                  lock2=1;
1577   5                  seg=cte_seg+14;
1578   5                  TH0=0X00;           //Inicializa timer                    *           
1579   5                  TL0=0X00;
1580   5                  TF0=0;
1581   5                }
1582   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x00)&&(buffer_wie[2]==0xf2))||((buffer_wie[0]==0x60
             -)&&(buffer_wie[1]==0x40)&&(buffer_wie[2]==0x94))||((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x00)&&(buffer_wie[2]==0xf3))|
             -|((buffer_wie[0]==0x37)&&(buffer_wie[1]==0x36)&&(buffer_wie[2]==0x24)))
1583   4                {
1584   5                  lock1=1;
1585   5                  lock2=1;
1586   5                  seg=cte_seg+14;
1587   5                  TH0=0X00;           //Inicializa timer                    *           
1588   5                  TL0=0X00;
1589   5                  TF0=0;
1590   5                }
1591   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x01)&&(buffer_wie[2]==0x10))||((buffer_wie[0]==0x7f
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 28  

             -)&&(buffer_wie[1]==0x75)&&(buffer_wie[2]==0x44))||((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x01)&&(buffer_wie[2]==0x11))|
             -|((buffer_wie[0]==0x17)&&(buffer_wie[1]==0xee)&&(buffer_wie[2]==0x24)))
1592   4                {
1593   5                  lock1=1;
1594   5                  lock2=1;
1595   5                  seg=cte_seg+14;
1596   5                  TH0=0X00;           //Inicializa timer                    *           
1597   5                  TL0=0X00;
1598   5                  TF0=0;
1599   5                }
1600   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x4f)&&(buffer_wie[2]==0xd7))||((buffer_wie[0]==0x67
             -)&&(buffer_wie[1]==0x17)&&(buffer_wie[2]==0xb4))||((buffer_wie[0]==0x94)&&(buffer_wie[1]==0xea)&&(buffer_wie[2]==0x75))|
             -|((buffer_wie[0]==0x7c)&&(buffer_wie[1]==0xde)&&(buffer_wie[2]==0x34)))
1601   4                {
1602   5                  lock1=1;
1603   5                  lock2=1;
1604   5                  seg=cte_seg+14;
1605   5                  TH0=0X00;           //Inicializa timer                    *           
1606   5                  TL0=0X00;
1607   5                  TF0=0;
1608   5                }
1609   4                else if (((buffer_wie[0]==0x94)&&(buffer_wie[1]==0xeb)&&(buffer_wie[2]==0x58))||((buffer_wie[0]==0x17
             -)&&(buffer_wie[1]==0x16)&&(buffer_wie[2]==0xd4))||((buffer_wie[0]==0x8f)&&(buffer_wie[1]==0x42)&&(buffer_wie[2]==0xd6)))
1610   4                {
1611   5                  lock1=1;
1612   5                  lock2=1;
1613   5                  seg=cte_seg+14;
1614   5                  TH0=0X00;           //Inicializa timer                    *           
1615   5                  TL0=0X00;
1616   5                  TF0=0;
1617   5                }
1618   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x1d)&&(buffer_wie[2]==0xbc))||((buffer_wie[0]==0x26
             -)&&(buffer_wie[1]==0x12)&&(buffer_wie[2]==0x84)))
1619   4                {
1620   5                  lock1=1;
1621   5                  lock2=1;
1622   5                  seg=cte_seg+14;
1623   5                  TH0=0X00;           //Inicializa timer                    *           
1624   5                  TL0=0X00;
1625   5                  TF0=0;
1626   5                }
1627   4                else if (((buffer_wie[0]==0x82)&&(buffer_wie[1]==0x88)&&(buffer_wie[2]==0x14))||((buffer_wie[0]==0x51
             -)&&(buffer_wie[1]==0xc1)&&(buffer_wie[2]==0x14)))
1628   4                {
1629   5                  lock1=1;
1630   5                  lock2=1;
1631   5                  seg=cte_seg+14;
1632   5                  TH0=0X00;           //Inicializa timer                    *           
1633   5                  TL0=0X00;
1634   5                  TF0=0;
1635   5                }
1636   4              }
1637   3      
1638   3      //--------------------------------------------------------------------------------------------------------
             ----*
1639   3        
1640   3            }
1641   2            else
1642   2            {
1643   3                
1644   3              if (completo==1)
1645   3              {
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 29  

1646   4                id_Access();                                        /*se muestra el nuemro de la tarjeta pero no hay presencia*/
1647   4            
1648   4                limpia_data();  
1649   4                SendRtaBus(ERROR_LOOP);                               /*envia un msj a segundario q hay un error en el loop*/
1650   4                lcd_text(1,0,(unsigned char *) "ERROR EN LOOP...");
1651   4                g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1652   4              }
1653   3              
1654   3      
1655   3            }
1656   2        
1657   2      //------------------------------------------------------------------------------------------*
1658   2      //    INTERRUPCION DEL AUXILIAR
1659   2      //------------------------------------------------------------------------------------------*
1660   2          if (ready==0)             //Recibe del procesador Aux (Interrupcion generada del Aux)
1661   2          {
1662   3            
1663   3            buffer_bus[0]=0xff;
1664   3            buffer_bus[1]=0xff;
1665   3            rx_bus();
1666   3          
1667   3            
1668   3            //DebugBufferMF(buffer_bus,num_data);
1669   3            /*
1670   3            lcd_text(0,0,(unsigned char *) " pto P0 ");     //jp
1671   3            temp=0xff;
1672   3            while(temp){temp--;}//jp
1673   3      //-----------------------------------  TEST
1674   3            for (k=0; k<num_data; k++)
1675   3              {
1676   3              tx_chr(buffer_bus[k]);
1677   3            }
1678   3      //-----------------------------------   
1679   3          */
1680   3            if (num_data!=0)
1681   3            {
1682   4                if ((num_data==1)&&(buffer_bus[0]==ACK))                        // ERRORES
1683   4              {
1684   5                Habilita_Lectura=1;
1685   5              }
1686   4      
1687   4              if ((num_data==1)&&(buffer_bus[0]>=0xDF)&&(buffer_bus[0]<=0xef))            // ERRORES
1688   4              {
1689   5                  prg_disp();
1690   5                if  ((buffer_bus[0]==0xe2)||(buffer_bus[0]==0xe3)||(buffer_bus[0]==0xe4))
1691   5                {
1692   6                    cont(0xc0);
1693   6                  for (k=0;err_mifare[k]!='\0';k++)
1694   6                  {
1695   7                      vdato(err_mifare[k]);
1696   7                  }
1697   6                  cont(0xcE);
1698   6                  vdato((buffer_bus[0]&0x0f)+0x30);
1699   6                }
1700   5      
1701   5                else if(buffer_bus[0]==0xe0)
1702   5                {
1703   6                      cont(0xc0);
1704   6                  for (k=0;sin_sensor[k]!='\0';k++)
1705   6                  {
1706   7                      vdato(sin_sensor[k]);
1707   7                  }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 30  

1708   6      
1709   6                }
1710   5                else if(buffer_bus[0]==0xe1)
1711   5                {
1712   6                      
1713   6                  lcd_text(1,0,(unsigned char *) "TARJETA INVALIDA");
1714   6                   
1715   6                }
1716   5                else if(buffer_bus[0]==0xe5)
1717   5                {
1718   6                      cont(0xc0);
1719   6                  for (k=0;err_cod[k]!='\0';k++)
1720   6                  {
1721   7                      vdato(err_cod[k]);
1722   7                  }
1723   6                }
1724   5                else if(buffer_bus[0]==0xe6)
1725   5                {
1726   6                    cont(0xc0);
1727   6                  for (k=0;err_in[k]!='\0';k++)
1728   6                  {
1729   7                      vdato(err_in[k]);
1730   7                  }
1731   6                }
1732   5                else if(buffer_bus[0]==0xe7)
1733   5                {
1734   6                
1735   6                  cont(0xc0);
1736   6                  lcd_puts((unsigned char *)"NO REGISTRA PAGO");
1737   6                  
1738   6                  
1739   6                  wait_long1(10000);
1740   6                  //{
1741   6                    //  vdato(err_sinpago[k]);
1742   6                  //}
1743   6                }
1744   5                else if(buffer_bus[0]==0xe8)
1745   5                {
1746   6                  cont(0xc0);
1747   6                  for (k=0;err_gracia[k]!='\0';k++)
1748   6                  {
1749   7                      vdato(err_gracia[k]);
1750   7                  }         
1751   6                }
1752   5      
1753   5                else if(buffer_bus[0]==0xe9)
1754   5                {
1755   6                  cont(0xc0);
1756   6                  for (k=0;err_out[k]!='\0';k++)
1757   6                  {
1758   7                      vdato(err_out[k]);
1759   7                  }         
1760   6                }
1761   5                else if(buffer_bus[0]==0xea)
1762   5                {
1763   6                  cont(0xc0);
1764   6                  for (k=0;err_data[k]!='\0';k++)
1765   6                  {
1766   7                      vdato(err_data[k]);
1767   7                  }         
1768   6                }
1769   5                else if(buffer_bus[0]==0xeB)
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 31  

1770   5                {
1771   6                  cont(0xc0);
1772   6                  for (k=0;err_Caja[k]!='\0';k++)
1773   6                  {
1774   7                      vdato(err_Caja[k]);
1775   7                  }         
1776   6                }
1777   5                else if(buffer_bus[0]==0xec)
1778   5                {
1779   6                  cont(0xc0);
1780   6                  for (k=0;tarjeta_venc[k]!='\0';k++)
1781   6                  {
1782   7                      vdato(tarjeta_venc[k]);
1783   7                  }         
1784   6                }
1785   5                else if (buffer_bus[0]==0xed)
1786   5                {
1787   6                  cont(0xc0);
1788   6                  for (k=0;sin_resp[k]!='\0';k++)
1789   6                  {
1790   7                      vdato(sin_resp[k]);
1791   7                  }         
1792   6                }
1793   5                else if (buffer_bus[0]==0xee)
1794   5                {
1795   6                  cont(0xc0);
1796   6                  for (k=0;resp_NACK[k]!='\0';k++)
1797   6                  {
1798   7                      vdato(resp_NACK[k]);
1799   7                  }         
1800   6                }
1801   5      
1802   5                else if (buffer_bus[0]==0xeF)
1803   5                {
1804   6                  cont(0xc0);
1805   6                  vdato('T');
1806   6                  vdato('A');
1807   6                  vdato('R');
1808   6                  vdato('J');
1809   6                  vdato('E');
1810   6                  vdato('T');
1811   6                  vdato('A');
1812   6                  vdato(' ');
1813   6                  vdato('A');
1814   6                  vdato('T');
1815   6                  vdato('A');
1816   6                  vdato('S');
1817   6                  vdato('C');
1818   6                  vdato('A');
1819   6                  vdato('D');
1820   6                  vdato('A');
1821   6      
1822   6      //            lock1=1;
1823   6                  Atascado=1;
1824   6                  seg=cte_seg;
1825   6                }
1826   5                else if (buffer_bus[0]==0xDF)
1827   5                { 
1828   6                  prg_disp();
1829   6                  cont(0xc0);
1830   6                  lcd_puts((unsigned char *) "TAR. SIN FORMATO");
1831   6                  
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 32  

1832   6                }
1833   5                msg_error=1;
1834   5                seg=cte_seg;
1835   5                TH0=0X00;               //Inicializa timer            *           
1836   5                TL0=0X00;
1837   5                TF0=0;
1838   5              }
1839   4              else if ((num_data==1)&&(buffer_bus[0]==0xa0))
1840   4              {
1841   5                audio1=1;
1842   5                msg1=1;
1843   5                seg=cte_seg;
1844   5              }
1845   4              else if ((num_data==1)&&(buffer_bus[0]==0xa1))
1846   4              {
1847   5                audio2=1;
1848   5                msg2=1;
1849   5                seg=cte_seg;
1850   5                lcd_text(0,0,(unsigned char *) "DIRIJASE A CAJA ");
1851   5              }
1852   4              else if ((num_data==1)&&(buffer_bus[0]==0xa2))
1853   4              {
1854   5                audio3=1;
1855   5                msg3=1;
1856   5                seg=cte_seg;
1857   5              }
1858   4              else if ((num_data==1)&&(buffer_bus[0]==0xA3))
1859   4              {
1860   5                audio4=1;
1861   5                msg4=1;
1862   5                seg=cte_seg+14;
1863   5              }
1864   4              else if ((num_data==1)&&(buffer_bus[0]==0XAF))
1865   4              {
1866   5                cont(0xc0);
1867   5      
1868   5                vdato('C');
1869   5                vdato('O');
1870   5                vdato('N');
1871   5                vdato('T');
1872   5                vdato('.');
1873   5                vdato(' ');
1874   5                vdato('E');
1875   5                vdato('V');
1876   5                vdato('N');
1877   5                vdato(' ');
1878   5                vdato('I');
1879   5                vdato('N');
1880   5                vdato('I');
1881   5                vdato('C');
1882   5                vdato('I');
1883   5                vdato('.');
1884   5      
1885   5              }
1886   4              else if ((num_data==1)&&(buffer_bus[0]=='N'))
1887   4              {
1888   5                notifyEVP=1;
1889   5      
1890   5                cont(0x80);
1891   5                for (k=0;MSGnotify[k]!='\0';k++)
1892   5                {
1893   6                  vdato(MSGnotify[k]);
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 33  

1894   6                }
1895   5                cont(0x8D);
1896   5                vdato('N');
1897   5                if (ACCESO_USE_LPR==1)
1898   5                {
1899   6                  vdato(' ');
1900   6                  vdato('M');
1901   6                }
1902   5                
1903   5              }
1904   4              else if ((num_data==1)&&(buffer_bus[0]=='S'))
1905   4              {
1906   5                notifyEVP=0;
1907   5                cont(0x80);
1908   5                for (k=0;MSGnotify[k]!='\0';k++)
1909   5                {
1910   6                  vdato(MSGnotify[k]);
1911   6                }
1912   5                cont(0x8D);
1913   5                vdato('S');
1914   5                if (ACCESO_USE_LPR==1)
1915   5                {
1916   6                  vdato(' ');
1917   6                  vdato('M');
1918   6                }
1919   5      
1920   5      
1921   5      
1922   5              }
1923   4              else if ((num_data==1)&&(buffer_bus[0]=='P'))
1924   4              {
1925   5                notifyEVP=0;
1926   5                cont(0xc0);
1927   5                for (k=0;matchPlate[k]!='\0';k++)
1928   5                {
1929   6                  vdato(matchPlate[k]);
1930   6                }
1931   5              }
1932   4              else if ((num_data==1)&&(buffer_bus[0]=='D'))
1933   4              {
1934   5                cont(0xc0);
1935   5                for (k=0;SendCode[k]!='\0';k++)
1936   5                {
1937   6                  vdato(SendCode[k]);
1938   6                }
1939   5              }
1940   4              else if ((num_data==1)&&(buffer_bus[0]==0XF1))
1941   4              {
1942   5                cont(0xc0);
1943   5      
1944   5                vdato('U');
1945   5                vdato('N');
1946   5                vdato(' ');
1947   5                vdato('M');
1948   5                vdato('O');
1949   5                vdato('M');
1950   5                vdato('E');
1951   5                vdato('N');
1952   5                vdato('T');
1953   5                vdato('O');
1954   5                vdato('.');
1955   5                vdato('.');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 34  

1956   5                vdato('.');
1957   5                vdato(' ');
1958   5                vdato(' ');
1959   5                vdato(' ');
1960   5      
1961   5      
1962   5      
1963   5              }
1964   4              else if ((num_data==1)&&(buffer_bus[0]==PICO_PLACA))
1965   4              {
1966   5                cont(0xc0);
1967   5      
1968   5                vdato('P');
1969   5                vdato('I');
1970   5                vdato('C');
1971   5                vdato('O');
1972   5                vdato(' ');
1973   5                vdato('Y');
1974   5                vdato(' ');
1975   5                vdato('P');
1976   5                vdato('L');
1977   5                vdato('A');
1978   5                vdato('C');
1979   5                vdato('A');
1980   5                vdato('.');
1981   5                vdato('.');
1982   5                vdato('.');
1983   5                vdato(' ');
1984   5      
1985   5              }
1986   4              else if ((num_data==1)&&(buffer_bus[0]==0XF8))
1987   4              {
1988   5                cont(0xc0);
1989   5      
1990   5                vdato('V');
1991   5                vdato('E');
1992   5                vdato('H');
1993   5                vdato('I');
1994   5                vdato('.');
1995   5                vdato(' ');
1996   5                vdato('I');
1997   5                vdato('N');
1998   5                vdato('V');
1999   5                vdato('A');
2000   5                vdato('L');
2001   5                vdato('I');
2002   5                vdato('D');
2003   5                vdato('O');
2004   5                vdato('.');
2005   5                vdato('.');
2006   5                vdato('.');
2007   5      
2008   5      
2009   5              }
2010   4              else if ((num_data==1)&&(buffer_bus[0]==0XF9))
2011   4              {
2012   5                cont(0xc0);
2013   5      
2014   5                vdato('S');
2015   5                vdato('A');
2016   5                vdato('L');
2017   5                vdato('I');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 35  

2018   5                vdato('D');
2019   5                vdato('A');
2020   5                vdato(' ');
2021   5                vdato('R');
2022   5                vdato('E');
2023   5                vdato('C');
2024   5                vdato('H');
2025   5                vdato('A');
2026   5                vdato('Z');
2027   5                vdato('A');
2028   5                vdato('D');
2029   5                vdato('A');
2030   5      
2031   5      
2032   5              }
2033   4              else if ((num_data==1)&&(buffer_bus[0]==SIN_TARJETAS))
2034   4              {
2035   5                cont(0xc0);
2036   5      
2037   5                vdato('S');
2038   5                vdato('I');
2039   5                vdato('N');
2040   5                vdato(' ');
2041   5                vdato('T');
2042   5                vdato('A');
2043   5                vdato('R');
2044   5                vdato('J');
2045   5                vdato('E');
2046   5                vdato('T');
2047   5                vdato('A');
2048   5                vdato('S');
2049   5                vdato(' ');
2050   5                vdato(' ');
2051   5                vdato(' ');
2052   5                vdato(' ');
2053   5      
2054   5      
2055   5              }
2056   4              else if ((num_data==1)&&(buffer_bus[0]==HORARIO))
2057   4              {
2058   5                cont(0xc0);
2059   5      
2060   5                vdato('F');
2061   5                vdato('U');
2062   5                vdato('E');
2063   5                vdato('R');
2064   5                vdato('A');
2065   5                vdato(' ');
2066   5                vdato('D');
2067   5                vdato('E');
2068   5                vdato(' ');
2069   5                vdato('H');
2070   5                vdato('O');
2071   5                vdato('R');
2072   5                vdato('A');
2073   5                vdato('R');
2074   5                vdato('I');
2075   5                vdato('O');
2076   5      
2077   5      
2078   5              }
2079   4              else if ((num_data==1)&&(buffer_bus[0]==IN_HORARIO))
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 36  

2080   4              {
2081   5                cont(0x80);
2082   5      
2083   5                vdato(' ');
2084   5                vdato('E');
2085   5                vdato('N');
2086   5                vdato('T');
2087   5                vdato('R');
2088   5                vdato('A');
2089   5                vdato('D');
2090   5                vdato('A');
2091   5                vdato(' ');
2092   5                vdato('F');
2093   5                vdato('U');
2094   5                vdato('E');
2095   5                vdato('R');
2096   5                vdato('A');
2097   5                vdato(' ');
2098   5                vdato(' ');
2099   5      
2100   5                cont(0xc0);
2101   5      
2102   5                vdato('D');
2103   5                vdato('E');
2104   5                vdato(' ');
2105   5                vdato('H');
2106   5                vdato('O');
2107   5                vdato('R');
2108   5                vdato('A');
2109   5                vdato('R');
2110   5                vdato('I');
2111   5                vdato('O');
2112   5                vdato(' ');
2113   5                vdato('-');
2114   5                vdato('C');
2115   5                vdato('A');
2116   5                vdato('J');
2117   5                vdato('A');
2118   5      
2119   5              }
2120   4              else if ((num_data==1)&&(buffer_bus[0]==DiaX))
2121   4              {
2122   5                cont(0x80);
2123   5      
2124   5                vdato('D');
2125   5                vdato('I');
2126   5                vdato('A');
2127   5                vdato(' ');
2128   5                vdato('D');
2129   5                vdato('E');
2130   5                vdato(' ');
2131   5                vdato('A');
2132   5                vdato('C');
2133   5                vdato('C');
2134   5                vdato('E');
2135   5                vdato('S');
2136   5                vdato('O');
2137   5                vdato(' ');
2138   5                vdato(' ');
2139   5                vdato(' ');
2140   5      
2141   5                cont(0xc0);
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 37  

2142   5      
2143   5                vdato('I');
2144   5                vdato('N');
2145   5                vdato('V');
2146   5                vdato('A');
2147   5                vdato('L');
2148   5                vdato('I');
2149   5                vdato('D');
2150   5                vdato('O');
2151   5                vdato(' ');
2152   5                vdato(' ');
2153   5                vdato(' ');
2154   5                vdato(' ');
2155   5                vdato(' ');
2156   5                vdato(' ');
2157   5                vdato(' ');
2158   5                vdato(' ');
2159   5      
2160   5              }
2161   4              else if ((num_data==1)&&(buffer_bus[0]==0XFb))
2162   4              {
2163   5                cont(0xc0);
2164   5      
2165   5                vdato('E');
2166   5                vdato('R');
2167   5                vdato('R');
2168   5                vdato('O');
2169   5                vdato('R');
2170   5                vdato(' ');
2171   5                vdato('T');
2172   5                vdato('R');
2173   5                vdato('A');
2174   5                vdato('N');
2175   5                vdato('S');
2176   5                vdato('P');
2177   5                vdato('O');
2178   5                vdato('R');
2179   5                vdato('T');
2180   5                vdato('E');
2181   5        
2182   5              }
2183   4              else if ((num_data==1)&&(buffer_bus[0]==0XFC))
2184   4              {
2185   5                cont(0xc0);
2186   5      
2187   5                vdato('N');
2188   5                vdato('O');
2189   5                vdato(' ');
2190   5                vdato('E');
2191   5                vdato('S');
2192   5                vdato(' ');
2193   5                vdato('M');
2194   5                vdato('E');
2195   5                vdato('N');
2196   5                vdato('S');
2197   5                vdato('U');
2198   5                vdato('A');
2199   5                vdato('L');
2200   5                vdato('.');
2201   5                vdato('.');
2202   5                vdato('.');
2203   5        
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 38  

2204   5              }
2205   4              else if ((num_data==1)&&(buffer_bus[0]==0XFD))
2206   4              {
2207   5                cont(0xc0);
2208   5      
2209   5                vdato('N');
2210   5                vdato('O');
2211   5                vdato(' ');
2212   5                vdato('E');
2213   5                vdato('S');
2214   5                vdato(' ');
2215   5                vdato('D');
2216   5                vdato('E');
2217   5                vdato(' ');
2218   5                vdato('R');
2219   5                vdato('O');
2220   5                vdato('T');
2221   5                vdato('A');
2222   5                vdato('C');
2223   5                vdato('I');
2224   5                vdato('O');
2225   5        
2226   5              }
2227   4              else if ((num_data==1)&&(buffer_bus[0]==0XFe))
2228   4              {
2229   5                cont(0xc0);
2230   5      
2231   5                vdato('B');
2232   5                vdato('I');
2233   5                vdato('E');
2234   5                vdato('N');
2235   5                vdato('V');
2236   5                vdato('E');
2237   5                vdato('N');
2238   5                vdato('I');
2239   5                vdato('D');
2240   5                vdato('O');
2241   5                vdato(' ');
2242   5                vdato(' ');
2243   5                vdato(' ');
2244   5                vdato(' ');
2245   5                vdato(' ');
2246   5                vdato(' ');
2247   5        
2248   5              }
2249   4              else if ((num_data==1)&&(buffer_bus[0]==0XFF))
2250   4              {
2251   5                cont(0x80);
2252   5      
2253   5                vdato('G');
2254   5                vdato('R');
2255   5                vdato('A');
2256   5                vdato('C');
2257   5                vdato('I');
2258   5                vdato('A');
2259   5                vdato('S');
2260   5                vdato('.');
2261   5                vdato('.');
2262   5                vdato('.');
2263   5                vdato(' ');
2264   5                vdato(' ');
2265   5                vdato(' ');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 39  

2266   5                vdato(' ');
2267   5                vdato(' ');
2268   5                vdato(' ');
2269   5        
2270   5              }
2271   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='i'))  // (num_data>=18)&&
2272   4              {
2273   5      
2274   5                  prg_disp();
2275   5                  
2276   5                  lcd_text(0,0,(unsigned char *) "Fecha Hora:     ");   //  muestra en el lcd la fecha                  
             -                   *
2277   5      
2278   5      //            cont(0x80);
2279   5      //            for (k=0;informa[k]!='\0';k++)
2280   5      //            {
2281   5      //              vdato(informa[k]);
2282   5      //            }
2283   5            
2284   5                  cont(0xc0); 
2285   5                  vdata_clk(buffer_bus[2]);     //año  [2]
2286   5                  vdato('/');
2287   5      
2288   5                  vdata_clk(buffer_bus[3]);     //mes
2289   5                  vdato('/');
2290   5      
2291   5                  vdata_clk(buffer_bus[4]);   //dia
2292   5                  vdato(' ');
2293   5      
2294   5                  vdata_clk(buffer_bus[5]);   //hora
2295   5                  vdato(':');
2296   5      
2297   5                  vdata_clk(buffer_bus[6]);   //minuto
2298   5                    
2299   5                    vdata_clk(buffer_bus[7]);   //segundo
2300   5      
2301   5                  cont(0x8c);
2302   5                  if (buffer_bus[8]==1)
2303   5                  {
2304   6                    vdato('D');
2305   6                    vdato('o');
2306   6                    vdato('m');
2307   6                  
2308   6                  }
2309   5                  else if (buffer_bus[8]==2)
2310   5                  {
2311   6                    vdato('L');
2312   6                    vdato('u');
2313   6                    vdato('n');
2314   6      
2315   6                  }
2316   5                  else if (buffer_bus[8]==3)
2317   5                  {
2318   6                    vdato('M');
2319   6                    vdato('a');
2320   6                    vdato('r');
2321   6      
2322   6                  }
2323   5                  else if (buffer_bus[8]==4)
2324   5                  {
2325   6                    vdato('M');
2326   6                    vdato('i');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 40  

2327   6                    vdato('e');
2328   6                  }
2329   5                  else if (buffer_bus[8]==5)
2330   5                  {
2331   6                    vdato('J');
2332   6                    vdato('u');
2333   6                    vdato('e');
2334   6                  }
2335   5                  else if (buffer_bus[8]==6)
2336   5                  {
2337   6                    vdato('V');
2338   6                    vdato('i');
2339   6                    vdato('e');
2340   6                  }
2341   5                  else if (buffer_bus[8]==7)
2342   5                  {
2343   6                    vdato('S');
2344   6                    vdato('a');
2345   6                    vdato('b');
2346   6                  }                         
2347   5              }
2348   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='I'))  // (num_data>=18)&&
2349   4              {
2350   5                cont(0x80);
2351   5                for (k=0;serie[k]!='\0';k++)
2352   5                {
2353   6                  vdato(serie[k]);
2354   6                }
2355   5                  temp=num_data-2;
2356   5                cont(0xc0);
2357   5                num_chr=0;
2358   5                for (k=0; k<temp; k++)
2359   5                {
2360   6                  if (buffer_bus[k+2]==ETX)
2361   6                  {
2362   7                    k=temp+1;
2363   7                  }
2364   6                  else
2365   6                  {
2366   7                    vdato(buffer_bus[k+2]);
2367   7                    num_chr++;
2368   7                  }
2369   6                }
2370   5                for (k=0; k<(16-num_chr); k++)
2371   5                {
2372   6                  vdato(' ');
2373   6                }
2374   5              }
2375   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='D'))  // (num_data>=18)&&
2376   4              {
2377   5                prg_disp();
2378   5                 cont(0x80);
2379   5                lcd_puts((unsigned char *) "ID_CLIENTE:");
2380   5                  for(k=2;;k++)
2381   5                  {
2382   6                    if(buffer_bus[k]!=';')
2383   6                     {
2384   7                      vdato(buffer_bus[k]);
2385   7                     }  else break;
2386   6                  }
2387   5                cont(0xc0);
2388   5                k++;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 41  

2389   5                  lcd_puts((unsigned char *) "COD_PARK:");
2390   5                    for(i=2;;k++)
2391   5                    {
2392   6                      if(buffer_bus[k]!=';')
2393   6                      {
2394   7                        vdato(buffer_bus[k]);
2395   7                      }else break;
2396   6                    }
2397   5                }
2398   4              
2399   4                else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]==05)&&(buffer_bus[2]==0x03))  // bcc hora
2400   4              {
2401   5                
2402   5                Retransmitir_trama_hora();
2403   5              }
2404   4                
2405   4                
2406   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='W')&&(buffer_bus[num_data-1]==ETX)&&(num_data==18))  /
             -/  
2407   4              {
2408   5                
2409   5                iTimeEsperaRtaLPR=0;
2410   5                
2411   5                Dato_OffLine=0;
2412   5                SalidaW=1;
2413   5      
2414   5                buffer_wie[0]=buffer_bus[4];
2415   5                buffer_wie[1]=buffer_bus[3];
2416   5                buffer_wie[2]=buffer_bus[2];
2417   5      
2418   5                YearIn=buffer_bus[6];
2419   5                MonthIn=buffer_bus[7];
2420   5                DayIn=buffer_bus[8];
2421   5                HourIn=buffer_bus[9];
2422   5                MinutIn=buffer_bus[10];
2423   5        
2424   5                YearOut=buffer_bus[11];
2425   5                MonthOut=buffer_bus[12];
2426   5                DayOut=buffer_bus[13];
2427   5                HourOut=buffer_bus[14];
2428   5                MinutOut=buffer_bus[15];
2429   5                Tipo_Vehiculo=buffer_bus[16];
2430   5                 
2431   5      
2432   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2433   5                TimeOut_Wiegand=5;
2434   5      
2435   5                
2436   5              }
2437   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='W')) //  
2438   4              {
2439   5                iTimeEsperaRtaLPR=0;
2440   5                
2441   5                Dato_OffLine=0;
2442   5                SalidaW=0;
2443   5      
2444   5                buffer_wie[0]=buffer_bus[4];
2445   5                buffer_wie[1]=buffer_bus[3];
2446   5                buffer_wie[2]=buffer_bus[2];
2447   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2448   5                TimeOut_Wiegand=5;
2449   5      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 42  

2450   5                
2451   5              }
2452   4              else if ((buffer_bus[0]==0x02)&&((buffer_bus[1]=='M'))) //  
2453   4              {
2454   5      
2455   5                iTimeEsperaRtaLPR=0;
2456   5                 lcd_wiegand();
2457   5              //  lcd_text(0,0,(unsigned char *) "LECT.           ");
2458   5                //  cont(0x87);               // Visualiza FC + ID
2459   5      //ojo         ve_fc(buffer_wie[0]);
2460   5              //  cont(0x8b);               // Visualiza FC + ID
2461   5      //          ve_id(buffer_wie[1],buffer_wie[2]);
2462   5      
2463   5                Dato_OffLine=0;
2464   5                buffer_wie[0]=buffer_bus[4];
2465   5                buffer_wie[1]=buffer_bus[3];
2466   5                buffer_wie[2]=buffer_bus[2];
2467   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2468   5                TimeOut_Wiegand=5;
2469   5                TimeOut_Send_Acceso=cte_seg*5;
2470   5      
2471   5              }
2472   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='w')&&(buffer_bus[num_data-1]==ETX))  //   inf del mc au
             -x    jp
2473   4              {
2474   5                
2475   5                iTimeEsperaRtaLPR=0;
2476   5      
2477   5                Dato_OffLine=1;
2478   5                Off_Line_Salida=0;
2479   5                Dato_Placa=0;
2480   5      
2481   5                // buffer_bus[5];    Parte del codigo de la tarjeta 4 bytes
2482   5              
2483   5                buffer_wie[0]=buffer_bus[4];
2484   5                buffer_wie[1]=buffer_bus[3];
2485   5                buffer_wie[2]=buffer_bus[2];
2486   5      
2487   5                YearIn=buffer_bus[6];
2488   5                MonthIn=buffer_bus[7];
2489   5                DayIn=buffer_bus[8];
2490   5                HourIn=buffer_bus[9];
2491   5                MinutIn=buffer_bus[10];
2492   5        
2493   5                if (num_data==18)
2494   5                {
2495   6                  YearOut=buffer_bus[11];
2496   6                  MonthOut=buffer_bus[12];
2497   6                  DayOut=buffer_bus[13];
2498   6                  HourOut=buffer_bus[14];
2499   6                  MinutOut=buffer_bus[15];
2500   6                  Tipo_Vehiculo=buffer_bus[16];
2501   6                  Off_Line_Salida=1;
2502   6                  Dato_Placa=0;
2503   6                                     // ojo jp
2504   6                   //lcd_text(1,0,(unsigned char *) "q pasa");
2505   6                   //while(1){};//jp
2506   6                }
2507   5                else if (num_data>18)
2508   5                {
2509   6      
2510   6                  YearOut=buffer_bus[11];
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 43  

2511   6                  MonthOut=buffer_bus[12];
2512   6                  DayOut=buffer_bus[13];
2513   6                  HourOut=buffer_bus[14];
2514   6                  MinutOut=buffer_bus[15];
2515   6      
2516   6                  Tipo_Vehiculo=buffer_bus[num_data-2];
2517   6                    // lcd_text(1,0,(unsigned char *) buffer_bus[num_data-2]);  //jp
2518   6                  //   while(1){};//jp
2519   6                  Off_Line_Salida=1;
2520   6                  Dato_Placa=1;
2521   6                  NumDatosPlate=0;
2522   6                  Max_Len_Placa=10;
2523   6        
2524   6                  for (k=16; k<num_data-2; k++)
2525   6                  {
2526   7                    if (buffer_bus[k]!=ETX)
2527   7                    {
2528   8                      buffer_placa[k-16]=buffer_bus[k];
2529   8                      NumDatosPlate++;
2530   8                    }
2531   7                    else
2532   7                    {
2533   8                      k=num_data;
2534   8                    }
2535   7                    
2536   7                  }
2537   6                }
2538   5                else
2539   5                {
2540   6                  Tipo_Vehiculo=buffer_bus[11];
2541   6                  //   lcd_text(1,0,(unsigned char *) buffer_bus[11]);  //jp
2542   6                  //   while(1){};//jp
2543   6                  Off_Line_Salida=0;
2544   6                }
2545   5                
2546   5      
2547   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2548   5                TimeOut_Wiegand=10;
2549   5       
2550   5              }
2551   4              else if ((buffer_bus[0]==STX)&&((buffer_bus[1]=='P')||(buffer_bus[1]=='T')||(buffer_bus[1]=='V')||(buf
             -fer_bus[1]=='E')||(buffer_bus[1]=='G')))  //  
2552   4              {
2553   5                iTimeEsperaRtaLPR=0;
2554   5                
2555   5                Rechazo=buffer_bus[1];
2556   5                len_buffer=num_data;
2557   5      //          len_buffer=buffer_bus[2];               //  Numero de Datos recibidos del Secunadario
2558   5                BorraLCD_L1();
2559   5                send_markCashierAut=0;                  // Incializa Marca de Liquidacion en Cajero
2560   5                Flag_Dcto=0;                      // Inicializa bandera de Salida con descuento
2561   5                cont(0x80);                       // Visualiza Lectura (hasta 1er separador)
2562   5                for (k=3; k<len_buffer; k++)            // Chequea datos
2563   5                {
2564   6                  if (((buffer_bus[k]>='0')&&(buffer_bus[k]<='9'))||((buffer_bus[k]>='A')&&(buffer_bus[k]<='Z'))||(buf
             -fer_bus[k]=='-')||(buffer_bus[k]=='.'))
2565   6                  {
2566   7                    datos_validos=1;
2567   7                  }
2568   6                  else
2569   6                  {
2570   7                    datos_validos=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 44  

2571   7                    k=len_buffer+1;
2572   7                  }
2573   6                  vdato(buffer_bus[k]);
2574   6                }
2575   5                if  (datos_validos==1)
2576   5                {
2577   6      //--------------------------------------------------------------------------------------------------------
             ------------------------------
2578   6                  i=0;
2579   6                  Tipo_Vehiculo=0;                 // Borra Tipo
2580   6                  for (k=0; k<len_buffer; k++)           // Busca Separador de Datos para Tipo Vehiculo
2581   6                  {
2582   7                    if (buffer_bus[k]=='.')
2583   7                    {
2584   8                      Tipo_Vehiculo=buffer_bus[k+1];      // Almacena Tipo Vehiculo de la tarjeta
2585   8                      k=len_buffer;
2586   8                    }
2587   7                  }
2588   6                  if (Tipo_Vehiculo!=0)
2589   6                  {
2590   7                    len_buffer=len_buffer-0x05;           // Quita: STX Letra #  punto TipoVehiculo = 5 Caracteres del tota
             -l
2591   7                  }
2592   6      //--------------------------------------------------------------------------------------------------------
             ------------------------------- 
2593   6                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2594   6                  
2595   6                  for (k=0; k<len_buffer; k++)
2596   6                  {
2597   7                    buffer_ticket[k]=buffer_bus[k+3];       //
2598   7                  }
2599   6      
2600   6                  //Habilita_Lectura=0;               // Inhabilita Aproximacion
2601   6                  //lcd_text(1,0,(unsigned char *) "APX. NO ACTIVA  ");
2602   6                }
2603   5                TimeOutLinea=TIMEW;
2604   5                TimeOut_Codigo=30;
2605   5              }
2606   4      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2607   4              else if ((buffer_bus[0]==STX)&&((buffer_bus[1]=='a'))&&(buffer_bus[num_data-1]==ETX)) //      STX "a" Ti
             -quete - Fecha_In - LPR ETX
2608   4              {
2609   5                  
2610   5      //            tx_chr(ACK);
2611   5      
2612   5                  iTimeEsperaRtaLPR=0;
2613   5      
2614   5      
2615   5                  Tiquete_Placa=1;
2616   5                  Tiquete_Salida=0;
2617   5                  NumChrTicket=0;
2618   5      
2619   5                  for (k=2; k<num_data; k++)            // Busca Separador de Datos para Tipo Vehiculo
2620   5                  {
2621   6                    if (buffer_bus[k]=='-')
2622   6                    {
2623   7                      Ini_Fecha=k+1;
2624   7                      k=num_data;
2625   7                    }
2626   6                  }
2627   5                  
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 45  

2628   5                
2629   5      
2630   5                  for (k=2; k<Ini_Fecha-1; k++)
2631   5                  {
2632   6                              
2633   6                    buffer_ticket[k-2]=buffer_bus[k];       //
2634   6                    NumChrTicket++;
2635   6                  }
2636   5                  
2637   5      
2638   5                    YearIn=buffer_bus[Ini_Fecha++];
2639   5                  MonthIn=buffer_bus[Ini_Fecha++];
2640   5                  DayIn=buffer_bus[Ini_Fecha++];
2641   5                  HourIn=buffer_bus[Ini_Fecha++];
2642   5                  MinutIn=buffer_bus[Ini_Fecha++];
2643   5      
2644   5      
2645   5                  Num_Char_LPR=0;
2646   5                  for (k=Ini_Fecha+1; k<num_data-1; k++)
2647   5                  {
2648   6                    buffer_placa[Num_Char_LPR++]=buffer_bus[k];
2649   6                  }
2650   5                  
2651   5                              
2652   5                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2653   5                  TimeOutLinea=TIMEW;
2654   5                  TimeOut_Codigo=30;            
2655   5      
2656   5      
2657   5              }
2658   4      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2659   4              else if (((buffer_bus[0]==STX)&&(buffer_bus[num_data-1]==ETX))&&((buffer_bus[1]=='m')||(buffer_bus[1]=
             -='n')||(buffer_bus[1]=='o')||(buffer_bus[1]=='A')||(buffer_bus[1]=='R'))) //  STX *** "m" "n" "o" *** ETX
2660   4              {
2661   5                if (buffer_bus[1]=='n')
2662   5                {
2663   6                  iTimeEsperaRtaLPR=0;
2664   6                  
2665   6                  ACCESO_USE_LPR=0;
2666   6                  cont(0x80);
2667   6                  for (k=0;MSGnotify[k]!='\0';k++)
2668   6                  {
2669   7                    vdato(MSGnotify[k]);
2670   7                  }
2671   6                  cont(0x8D);
2672   6                  (notifyEVP==1)?(vdato('N')):(vdato('S'));
2673   6                  
2674   6                  vdato(' ');
2675   6                  vdato('N');
2676   6      
2677   6      
2678   6                }
2679   5                else if (buffer_bus[1]=='m')
2680   5                {
2681   6                  ACCESO_USE_LPR=1;
2682   6      
2683   6                  cont(0x80);
2684   6                  for (k=0;MSGnotify[k]!='\0';k++)
2685   6                  {
2686   7                    vdato(MSGnotify[k]);
2687   7                  }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 46  

2688   6                  cont(0x8D);
2689   6                  (notifyEVP==1)?(vdato('N')):(vdato('S'));
2690   6                  
2691   6                  vdato(' ');
2692   6                  vdato('M');
2693   6                  
2694   6      
2695   6      
2696   6      
2697   6                }
2698   5                else if (buffer_bus[1]=='o')
2699   5                {
2700   6                  if (buffer_bus[2]=='0')
2701   6                  {
2702   7                    ACCESO_USE_LPR=0;
2703   7                    iTimeEsperaRtaLPR=0;
2704   7      
2705   7                    cont(0x80);
2706   7                    for (k=0;MSGnotify[k]!='\0';k++)
2707   7                    {
2708   8                      vdato(MSGnotify[k]);
2709   8                    }
2710   7                    cont(0x8D);
2711   7                    (notifyEVP==1)?(vdato('N')):(vdato('S'));
2712   7                    
2713   7                    vdato(' ');
2714   7                    vdato('o');
2715   7      
2716   7                  }
2717   6                  else if (buffer_bus[2]=='1')
2718   6                  {
2719   7                    ACCESO_USE_LPR=1;
2720   7                    cont(0x80);
2721   7                    for (k=0;MSGnotify[k]!='\0';k++)
2722   7                    {
2723   8                      vdato(MSGnotify[k]);
2724   8                    }
2725   7                    cont(0x8D);
2726   7                    (notifyEVP==1)?(vdato('N')):(vdato('S'));
2727   7                    
2728   7                    vdato(' ');
2729   7                    vdato('M');
2730   7                  }
2731   6                }
2732   5                else if (buffer_bus[1]=='A')              // Acepta de LPR
2733   5                {
2734   6                  if (iTimeEsperaRtaLPR!=0)
2735   6                  {
2736   7                    iTimeEsperaRtaLPR=0;
2737   7      
2738   7                    buffer_wie[0]=buffer_wieLPR[0];
2739   7                    buffer_wie[1]=buffer_wieLPR[1];
2740   7                    buffer_wie[2]=buffer_wieLPR[2];
2741   7                    g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2742   7                    TimeOut_Wiegand=5;
2743   7                    SalidaW=0;
2744   7                  }
2745   6       
2746   6                }
2747   5                else if (buffer_bus[1]=='R')            // Rechaza de LPR
2748   5                {
2749   6                      iTimeEsperaRtaLPR=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 47  

2750   6                    cont(0x80);
2751   6                    for (k=0;MSGnegado[k]!='\0';k++)
2752   6                    {
2753   7                      vdato(MSGnegado[k]);
2754   7                    }
2755   6       
2756   6                }
2757   5                buffer_bus[1]=0xff;                 
2758   5       
2759   5              }
2760   4      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2761   4              else if ((buffer_bus[0]==STX)&&((buffer_bus[1]=='s')||(buffer_bus[1]=='C'))&&(buffer_bus[num_data-1]==
             -ETX))  //      STX "s" Tiquete - Fecha_In - Fecha Out - LPR ETX
2762   4              {
2763   5                  
2764   5                  iTimeEsperaRtaLPR=0;
2765   5      
2766   5                  Tiquete_Placa=1;
2767   5                  Tiquete_Salida=1;
2768   5                  NumChrTicket=0;
2769   5      
2770   5                  if (buffer_bus[1]=='C')
2771   5                  {
2772   6                    send_markCashierAut=1;
2773   6                  }
2774   5                  else
2775   5                  {
2776   6                    send_markCashierAut=0;
2777   6                  }
2778   5      
2779   5      
2780   5      
2781   5                  for (k=2; k<num_data; k++)            // Busca Separador de Datos para Tipo Vehiculo
2782   5                  {
2783   6                    if (buffer_bus[k]=='-')
2784   6                    {
2785   7                      Ini_Dcto=k+1;
2786   7                      k=num_data;
2787   7                    }
2788   6                  }
2789   5      
2790   5                  Cod_Dcto=buffer_bus[Ini_Dcto];
2791   5      
2792   5                  for (k=2; k<Ini_Dcto-1; k++)
2793   5                  {
2794   6                    buffer_ticket[k-2]=buffer_bus[k];       //
2795   6                    NumChrTicket++;
2796   6                  }
2797   5      
2798   5                  
2799   5                  Ini_Fecha=Ini_Dcto+2;
2800   5      
2801   5      
2802   5                    YearIn=buffer_bus[Ini_Fecha++];
2803   5                  MonthIn=buffer_bus[Ini_Fecha++];
2804   5                  DayIn=buffer_bus[Ini_Fecha++];
2805   5                  HourIn=buffer_bus[Ini_Fecha++];
2806   5                  MinutIn=buffer_bus[Ini_Fecha++];
2807   5      
2808   5                  Ini_Fecha++;
2809   5      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 48  

2810   5                  YearOut=buffer_bus[Ini_Fecha++];
2811   5                  MonthOut=buffer_bus[Ini_Fecha++];
2812   5                  DayOut=buffer_bus[Ini_Fecha++];
2813   5                  HourOut=buffer_bus[Ini_Fecha++];
2814   5                  MinutOut=buffer_bus[Ini_Fecha++];
2815   5      
2816   5                  Ini_Fecha++;
2817   5      
2818   5                  Tipo_Vehiculo=buffer_bus[Ini_Fecha++];
2819   5      
2820   5                  Num_Char_LPR=0;
2821   5                              
2822   5                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2823   5                  TimeOutLinea=TIMEW;
2824   5                  TimeOut_Codigo=30;
2825   5                            
2826   5      
2827   5      
2828   5              }
2829   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='d')&&(buffer_bus[num_data-1]==ETX)&&(num_data==9)) //
             -    DINERO de SALDO
2830   4              {
2831   5                BorraLCD_L1();  
2832   5                  cont(0x80); 
2833   5      
2834   5                vdato('S');
2835   5                vdato('a');
2836   5                vdato('l');
2837   5                vdato('d');
2838   5                vdato('o');
2839   5                vdato(' ');
2840   5                vdato('D');
2841   5                vdato('i');
2842   5                vdato('s');
2843   5                vdato('p');
2844   5                vdato('o');
2845   5                vdato('n');
2846   5                vdato('i');
2847   5                vdato('b');
2848   5                vdato('l');
2849   5                vdato('e'); 
2850   5      
2851   5                BorraLCD_L2();
2852   5                cont(0xc0);
2853   5                
2854   5                for (k=2; k<8; k++)
2855   5                {
2856   6                  vdato(buffer_bus[k]);
2857   6                }       
2858   5              }
2859   4              else                          //
2860   4              {
2861   5      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2862   5                len_buffer=num_data;                  //  Numero de Datos recibidos del Secunadario
2863   5                BorraLCD_L1();
2864   5      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2865   5                Tipo_Vehiculo=0;                  // Borra Tipo
2866   5                for (k=0; k<len_buffer; k++)            // Busca Separador de Datos para Tipo Vehiculo
2867   5                {
2868   6                  if (buffer_bus[k]=='.')
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 49  

2869   6                  {
2870   7                    Tipo_Vehiculo=buffer_bus[k+1];        // Almacena Tipo Vehiculo de la tarjeta
2871   7                    k=len_buffer;
2872   7                  }
2873   6                }
2874   5                if (Tipo_Vehiculo!=0)               // H T B M C (LETRAS DEL TIPO DE VEHICULO)
2875   5                {
2876   6                    len_buffer=len_buffer-0x02;           // Quita: punto TipoVehiculo = 2 Caracteres del total
2877   6                }
2878   5      //--------------------------------------------------------------------------------------------------------
             -------------------------------
2879   5                send_markCashierAut=0;                 // Incializa Marca de Liquidacion en Cajero
2880   5                Flag_Dcto=0;                     // Inicializa bandera de Salida con descuento
2881   5                i=0;
2882   5                for (k=0; k<len_buffer; k++)             // Busca Separador de Datos
2883   5                {
2884   6                  if (buffer_bus[k]=='-')
2885   6                  {
2886   7                    PosComa[i++]=k;
2887   7                  }
2888   6                }
2889   5      //--------------------------------------------------------------------------------------------------------
             -------------------------------
2890   5                (i!=0)?(NumDatValidar=PosComa[0]+1):(NumDatValidar=len_buffer);   // EXTRAE SOLO EL CODIGO PARA VALID
             -AD DATOS
2891   5      //--------------------------------------------------------------------------------------------------------
             -------------------------------
2892   5                cont(0x80);                       // Visualiza Lectura (hasta 1er separador)
2893   5                for (k=0; k<NumDatValidar; k++)           // Chequea datos
2894   5                {
2895   6                  if (((buffer_bus[k]>='0')&&(buffer_bus[k]<='9'))||((buffer_bus[k]>='A')&&(buffer_bus[k]<='Z'))||(buf
             -fer_bus[k]=='-')||(buffer_bus[k]=='.'))
2896   6                  {
2897   7                    datos_validos=1;
2898   7                  }
2899   6                  else
2900   6                  {
2901   7                    datos_validos=0;
2902   7                    k=NumDatValidar+1;
2903   7                  }
2904   6                  vdato(buffer_bus[k]);
2905   6                }
2906   5      //----------------------------------------------------------------------
2907   5                if  (datos_validos==1)
2908   5                {
2909   6                  iTimeEsperaRtaLPR=0;
2910   6                  
2911   6                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2912   6                
2913   6                  //Habilita_Lectura=0;               // Inhabilita Aproximacion
2914   6                  //lcd_text(1,0,(unsigned char *) "APX. NO ACTIVA  ");
2915   6              
2916   6                  if (i!=0)
2917   6                  {
2918   7                    if (i==1)
2919   7                    {
2920   8                      if ((len_buffer-1-PosComa[0])==1)       // Solo Cod Descuento, Evalua cantidad de datos si es 1 xq e
             -s solo codigo Dcto
2921   8                      {
2922   9                        for (k=0; k<len_buffer; k++)
2923   9                        {
2924  10                          buffer_ticket[k]=buffer_bus[k];
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 50  

2925  10                    
2926  10                        }
2927   9                        Flag_Dcto=1;
2928   9                        Cod_Dcto= buffer_ticket[len_buffer-1];
2929   9                        vdato('D');
2930   9                        vdato(Cod_Dcto);
2931   9                        len_buffer=len_buffer-2;                
2932   9                      }
2933   8                      else                      // Solo Liquidacion en Cajero Posee mas de un dato, o sea la fecha
2934   8                      {
2935   9                        Flag_Dcto=0;
2936   9                        for (k=0; k<PosComa[0]; k++)
2937   9                        {
2938  10                          buffer_ticket[k]=buffer_bus[k];
2939  10                          
2940  10                        }
2941   9                                          
2942   9                        if ((len_buffer-1-PosComa[0])==5)     // 5 datos de: YMDHM  (Año Mes Dia Hor Min)
2943   9                        {
2944  10                          send_markCashierAut=1;
2945  10      
2946  10                          vdato('C');
2947  10                          vdato('a');
2948  10                          vdato('j');
2949  10                          vdato('e');
2950  10                          vdato('r');
2951  10                          vdato('o');
2952  10      
2953  10                          Ini_Fecha=PosComa[0]+1; 
2954  10                                            
2955  10                          YearIn=buffer_bus[Ini_Fecha++];
2956  10                          MonthIn=buffer_bus[Ini_Fecha++];
2957  10                          DayIn=buffer_bus[Ini_Fecha++];
2958  10                          HourIn=buffer_bus[Ini_Fecha++];
2959  10                          MinutIn=buffer_bus[Ini_Fecha];
2960  10                          
2961  10                        }
2962   9                        len_buffer=PosComa[0];
2963   9                      } 
2964   8                    }
2965   7                    else                            // Posee Codigo de descuento y Liquidado en Cajero
2966   7                    {
2967   8                        for (k=0; k<PosComa[0]; k++)
2968   8                      {
2969   9                        buffer_ticket[k]=buffer_bus[k];
2970   9                      }
2971   8                      
2972   8                      Flag_Dcto=1;
2973   8                      Cod_Dcto= buffer_ticket[PosComa[0]+1];
2974   8                      
2975   8                      
2976   8                      send_markCashierAut=1;
2977   8                      Ini_Fecha=PosComa[1]+1;
2978   8                                          
2979   8                      YearIn=buffer_bus[Ini_Fecha++];
2980   8                      MonthIn=buffer_bus[Ini_Fecha++];
2981   8                      DayIn=buffer_bus[Ini_Fecha++];
2982   8                      HourIn=buffer_bus[Ini_Fecha++];
2983   8                      MinutIn=buffer_bus[Ini_Fecha];
2984   8      
2985   8                      len_buffer=PosComa[0];                                
2986   8                    }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 51  

2987   7                  }
2988   6                  else                            // Dato sin nada fuera de lo normal.
2989   6                  {
2990   7                    for (k=0; k<len_buffer; k++)
2991   7                    {
2992   8                      buffer_ticket[k]=buffer_bus[k];
2993   8                    }
2994   7                      Flag_Dcto=0;
2995   7                    send_markCashierAut=0;
2996   7                  }
2997   6      
2998   6                  TimeOutLinea=TIMEW;
2999   6                  TimeOut_Codigo=30;
3000   6                }
3001   5      //---------------------------------------------------------------------         
3002   5                }
3003   4            }
3004   3            else
3005   3            {
3006   4      //        cont(0x8E);
3007   4      //        temp=(buffer_bus[0]&0xf0);
3008   4      //        temp>>=4;
3009   4      //        vdato(temp);
3010   4      //        vdato((buffer_bus[0]&0x0f)+0x30);
3011   4      
3012   4            }
3013   3          }
3014   2      
3015   2          if(TF0==1)
3016   2          {
3017   3            TF0=0;
3018   3      //----------------------------------------------------------------------------------------------*
3019   3            if (TimeRetryCmd!=0)
3020   3            {
3021   4              TimeRetryCmd--;
3022   4              if (TimeRetryCmd==0)
3023   4              {
3024   5                RetryCmd=1;
3025   5              }
3026   4            }
3027   3      //----------------------------------------------------------------------------------------------*
3028   3            if (TimeOut_Send_Acceso!=0)
3029   3            {
3030   4              TimeOut_Send_Acceso--;
3031   4            }
3032   3            if (OpenMensual_Apx!=0)
3033   3            {
3034   4              OpenMensual_Apx--;
3035   4            }
3036   3      //----------------------------------------------------------------------------------------------*
3037   3            if (iTimeEsperaRtaLPR!=0)
3038   3            {
3039   4              iTimeEsperaRtaLPR--;
3040   4              if (iTimeEsperaRtaLPR==0)
3041   4              {
3042   5                  buffer_wie[0]=buffer_wieLPR[0];
3043   5                  buffer_wie[1]=buffer_wieLPR[1];
3044   5                  buffer_wie[2]=buffer_wieLPR[2];
3045   5                  g_cEstadoTxSoft |= LECTURA_WIEG_TX;
3046   5                  TimeOut_Wiegand=5;
3047   5                  SalidaW=0;
3048   5              }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 52  

3049   4            }
3050   3      //----------------------------------------------------------------------------------------------*
3051   3            if (SignalAcceso==0)
3052   3            {
3053   4              if ((seg==cte_seg/2)||(seg==0))
3054   4              {
3055   5                if (toggle==1)
3056   5                {
3057   6                  ledv=0;
3058   6                  toggle=0;
3059   6                }
3060   5                else
3061   5                {
3062   6                  ledv=1;
3063   6                  toggle=1;
3064   6                }
3065   5              }
3066   4            }
3067   3            else
3068   3            {
3069   4              ledv=1;
3070   4              Habilita_Lectura=1;               // Habilita Lectura
3071   4            }
3072   3      //----------------------------------------------------------------------------------------------*
3073   3            seg--;
3074   3            if (seg==0)
3075   3            {
3076   4                if (FueraLinea==1)
3077   4              {
3078   5                if (Seg_OFF!=0)
3079   5                {
3080   6                  Seg_OFF--;
3081   6                }
3082   5                if (Seg_OFF==0)
3083   5                {
3084   6                  buffer_bus[0]=OFF_LINE;   
3085   6                  tx_bus(1);
3086   6                  Seg_OFF=5;
3087   6                }
3088   5                }
3089   4              else
3090   4              {
3091   5                Seg_OFF=5;  
3092   5              }
3093   4                if (TimeOut_Codigo!=0)
3094   4              {
3095   5                TimeOut_Codigo--;
3096   5                if (TimeOut_Codigo==0)
3097   5                {
3098   6                  g_cEstadoTxSoft &=~LECTURA_COD_TX;
3099   6                  Rechazo=0;
3100   6      
3101   6                  Tiquete_Placa=0;
3102   6                  Tiquete_Salida=0;
3103   6                  Tipo_Vehiculo=' ';
3104   6                  send_markCashierAut=0;
3105   6                  if (FueraLinea==1)
3106   6                  {
3107   7                    BorraLCD_L1();
3108   7                    }
3109   6                }
3110   5              }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 53  

3111   4                if (TimeOut_Wiegand!=0)
3112   4              {
3113   5                TimeOut_Wiegand--;
3114   5                if (TimeOut_Wiegand==0)
3115   5                {
3116   6                  g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
3117   6                  SalidaW=0;
3118   6                  Dato_Placa=0;
3119   6      //            Off_Line_Salida=0;
3120   6                }
3121   5              }
3122   4              if (TimeOutLinea!=0)
3123   4              {
3124   5                TimeOutLinea--;
3125   5                if (TimeOutLinea==0)                      /*fuera de linea*/
3126   5                {
3127   6                  TimeOutLinea=TIMEW;
3128   6                  cont(0x80);
3129   6                  for (k=0;k<16;k++)
3130   6                  {
3131   7                      vdato(' ');
3132   7                  }
3133   6                  g_cEstadoTxSoft &=~LECTURA_COD_TX;
3134   6                  g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
3135   6                  g_cEstadoTxSoft &=~COD_PRINT_TX;
3136   6                  FueraLinea=1;
3137   6                  Rechazo=0;
3138   6                  Dato_Placa=0;
3139   6                  send_markCashierAut=0;
3140   6                  Tiquete_Placa=0;
3141   6                  Tiquete_Salida=0;
3142   6                  Dato_Placa=0;
3143   6                  cont(0xc0);
3144   6                  for (k=0;linea[k]!='\0';k++)
3145   6                  {
3146   7                      vdato(linea[k]);
3147   7                  }
3148   6                  buffer_bus[0]=OFF_LINE;   
3149   6                  tx_bus(1);
3150   6                }
3151   5              }
3152   4               
3153   4      
3154   4              Atascado=0;
3155   4              lock1=0;
3156   4              lock2=0;
3157   4      
3158   4              audio1=0;
3159   4              msg1=0;
3160   4              audio2=0;
3161   4              msg2=0;
3162   4              audio3=0;
3163   4              msg3=0;
3164   4              audio4=0;
3165   4              msg4=0;
3166   4      
3167   4            
3168   4              seg=cte_seg;
3169   4              TH0=0X00;               //Inicializa timer                  *           
3170   4              TL0=0X00;
3171   4              TF0=0;
3172   4              msg_error=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      10/19/2021 10:44:37 PAGE 54  

3173   4      
3174   4      
3175   4            }
3176   3      
3177   3          }
3178   2      //********************************************************************************************************
             -***
3179   2          if ((RetryCmd==1)&&(ready==1))
3180   2          {
3181   3              RetryCmd=0;
3182   3            for (temp=0; temp<NumDatRetry; temp++)
3183   3            {
3184   4              buffer_bus[temp]=BufferRetry[temp];
3185   4            }
3186   3            tx_bus(NumDatRetry);
3187   3          }
3188   2      //********************************************************************************************************
             -***
3189   2          if (txACK==1)
3190   2          {
3191   3            tx_chr(ACK);                        
3192   3            txACK=0;
3193   3          }
3194   2      //********************************************************************************************************
             -***
3195   2          if( ((g_cEstadoComSoft==POLL_COM_SOF)||(g_cEstadoComSoft==ANALICE_STR_SOF)))  
3196   2          {                                        
3197   3        
3198   3      
3199   3            AtencComSoft();
3200   3          }
3201   2      //********************************************************************************************************
             -***
3202   2          if ((Tx_Acceso==1)&&(ready==1))
3203   2          { 
3204   3            Tx_Acceso=0;
3205   3            buffer_bus[0]=ACCESO;
3206   3            tx_bus(1);
3207   3          
3208   3          //  lcd_text(0,0,(unsigned char *) "ENVIANDO ACCESO ");
3209   3      
3210   3              buffer_bus[0]=0x00;
3211   3            tx_bus(1);
3212   3          }           
3213   2      //***********************************************************************************************
3214   2          relevos_aux();
3215   2        }
3216   1        }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  14738    ----
   CONSTANT SIZE    =    243    ----
   XDATA SIZE       =    516     112
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     38       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
